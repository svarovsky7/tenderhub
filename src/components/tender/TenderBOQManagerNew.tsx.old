import React, { useState, useEffect, useCallback } from 'react';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { PlusOutlined, EditOutlined, CloseOutlined, DisconnectOutlined, HolderOutlined, LinkOutlined, PlusCircleOutlined, SwapOutlined, SendOutlined, DeleteOutlined, ReloadOutlined } from '@ant-design/icons';
import { message, Spin, InputNumber, Tooltip, Modal, Button, Input, Radio, List, Empty, Select } from 'antd';
// Drag-and-drop disabled - using modal for material movement
import { clientPositionsApi, boqItemsApi, boqApi, tendersApi } from '../../lib/supabase/api';
import { workMaterialLinksApi } from '../../lib/supabase/api/work-material-links';
import { supabase } from '../../lib/supabase/client';
import AutoCompleteSearch from '../common/AutoCompleteSearch';
import { CostCascadeSelector } from '../common';
import { formatCurrency, formatQuantity, formatUnitRate } from '../../utils/formatters';
import { CURRENCY_SYMBOLS, CURRENCY_OPTIONS } from '../../utils/currencyConverter';
import { calculateMaterialVolume, updateLinkWithCalculatedVolume } from '../../utils/materialCalculations';
import { performanceMonitor, measureRender, measureDataProcessing, monitorQueryCache } from '../../utils/performanceMetrics';
// Components for drag-and-drop removed - using modal approach
import type { ClientPosition, BOQItem, BOQItemInsert, DeliveryPriceType } from '../../lib/supabase/types';

interface TenderBOQManagerNewProps {
  tenderId: string;
}

interface PositionWithItems extends ClientPosition {
  boq_items?: BOQItem[];
  total_position_cost?: number;
}

const TenderBOQManagerNew: React.FC<TenderBOQManagerNewProps> = ({ tenderId }) => {
  // Toggle for detailed logging (set to false to reduce console noise)
  const ENABLE_DETAILED_LOGGING = false;

  const debugLog = (message: string, ...args: any[]) => {
    if (ENABLE_DETAILED_LOGGING) {
      console.log(message, ...args);
    }
  };

  // Performance monitoring setup
  const endRenderMeasurement = measureRender('TenderBOQManagerNew');

  useEffect(() => {
    performanceMonitor.startSession(`BOQ-Manager-${tenderId}`);
    return () => {
      endRenderMeasurement();
    };
  }, [tenderId]);

  // React Query client for cache management
  const queryClient = useQueryClient();

  // State (keeping other states that don't need caching)
  const [selectedPosition, setSelectedPosition] = useState<PositionWithItems | null>(null);
  const [allWorkLinks, setAllWorkLinks] = useState<Record<string, any[]>>({});

  // Performance timing state
  const [loadingStartTime, setLoadingStartTime] = useState<number | null>(null);

  // Lazy loading state for BOQ items
  const [loadedPositionItems, setLoadedPositionItems] = useState<Record<string, BOQItem[]>>({});
  const [loadingPositionItems, setLoadingPositionItems] = useState<Record<string, boolean>>({});
  const [editingLinkId, setEditingLinkId] = useState<string | null>(null);
  const [editingLinkData, setEditingLinkData] = useState<any>({});
  
  // Move material modal state
  const [moveModal, setMoveModal] = useState<{
    visible: boolean;
    materialId: string | null;
    materialName: string;
    currentWorkId: string | null;
    currentWorkName: string;
    isLinkedMaterial: boolean;
    linkId?: string;
  }>({
    visible: false,
    materialId: null,
    materialName: '',
    currentWorkId: null,
    currentWorkName: '',
    isLinkedMaterial: false
  });
  
  // State for editing item
  const [editingItem, setEditingItem] = useState<BOQItem | null>(null);
  const [editFormData, setEditFormData] = useState<{
    description: string;
    quantity: number;
    unit_rate: number;
    consumption_coefficient?: number;
    conversion_coefficient?: number;
    delivery_price_type?: 'included' | 'not_included' | 'amount';
    delivery_amount?: number;
    cost_node_id?: string | null;
    cost_node_display?: string | null;
    currency_type?: 'RUB' | 'USD' | 'EUR' | 'CNY';
    currency_rate?: number | null;
  }>({
    description: '',
    quantity: 0,
    unit_rate: 0,
    consumption_coefficient: 1,
    conversion_coefficient: 1,
    delivery_price_type: 'included',
    delivery_amount: 0,
    currency_type: 'RUB'
  });
  
  // Conflict resolution modal state
  const [conflictModal, setConflictModal] = useState<{
    visible: boolean;
    srcId: string | null;
    tgtId: string | null;
    targetWorkId: string | null;
    materialName: string;
    sourceworkName: string;
    targetWorkName: string;
  }>({
    visible: false,
    srcId: null,
    tgtId: null,
    targetWorkId: null,
    materialName: '',
    sourceworkName: '',
    targetWorkName: ''
  });
  const [conflictStrategy, setConflictStrategy] = useState<'sum' | 'replace'>('sum');
  const [formData, setFormData] = useState({
    type: 'work' as 'work' | 'material',
    name: '',
    unit: 'м²',
    quantity: '',
    price: '',
    consumptionCoefficient: '',
    conversionCoefficient: '',
    selectedItemId: null as string | null,
    deliveryPriceType: 'included' as 'included' | 'not_included' | 'amount',
    deliveryAmount: '',
    cost_node_id: null as string | null,
    cost_node_display: null as string | null
  });
  
  // Состояние для курсов валют из тендера
  const [tenderRates, setTenderRates] = useState<{
    usd_rate: number | null;
    eur_rate: number | null;
    cny_rate: number | null;
  }>({
    usd_rate: null,
    eur_rate: null,
    cny_rate: null
  });
  // Remove these states as AutoCompleteSearch handles loading
  // const [materials, setMaterials] = useState<Material[]>([]);
  // const [works, setWorks] = useState<WorkItem[]>([]);

  const units = ['м²', 'м³', 'шт.', 'кг', 'т', 'м.п.', 'компл.'];
  
  // Функция форматирования цены с символом валюты
  const formatPriceWithCurrency = (price: number, currencyType?: string) => {
    const currency = currencyType || 'RUB';
    const symbol = CURRENCY_SYMBOLS[currency] || '₽';
    
    if (currency === 'RUB') {
      return formatCurrency(price);
    }
    
    // Для валют показываем символ перед суммой
    return `${symbol}${price.toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
  };
  
  // Функция расчета итоговой суммы с учетом валюты
  const calculateTotalAmount = (item: {
    item_type: string;
    unit_rate: number;
    quantity: number;
    currency_type?: string;
    currency_rate?: number | null;
    delivery_price_type?: string;
    delivery_amount?: number | null;
  }) => {
    // Конвертируем цену в рубли если указана валюта
    const priceInRub = item.currency_type && item.currency_type !== 'RUB' && item.currency_rate
      ? item.unit_rate * item.currency_rate
      : item.unit_rate;
    
    // Для материалов учитываем доставку
    if (item.item_type === 'material' || item.item_type === 'sub_material') {
      let deliveryAmount = 0;
      
      if (item.delivery_price_type === 'not_included') {
        // 3% от цены в рублях
        deliveryAmount = priceInRub * 0.03;
      } else if (item.delivery_price_type === 'amount') {
        // Фиксированная сумма (в рублях)
        deliveryAmount = item.delivery_amount || 0;
      }
      // Для 'included' deliveryAmount остается 0
      
      return (priceInRub + deliveryAmount) * item.quantity;
    }
    
    // Для работ просто умножаем на количество
    return priceInRub * item.quantity;
  };
  
  // Helper function to calculate total cost including all works and materials
  const calculatePositionTotalCost = (items: BOQItem[], workLinks: Record<string, any[]>) => {
    let total = 0;
    let worksTotal = 0;
    let linkedMaterialsTotal = 0;
    let unlinkedMaterialsTotal = 0;
    
    // Calculate costs for works, linked materials, and unlinked materials
    
    // Создаем список ID связанных материалов
    const linkedMaterialIds = new Set<string>();
    Object.values(workLinks || {}).forEach((links: any[]) => {
      links.forEach((link: any) => {
        if (link.material_boq_item_id) {
          linkedMaterialIds.add(link.material_boq_item_id);
        }
      });
    });
    
    // Считаем работы, привязанные материалы и несвязанные материалы
    for (const item of items || []) {
      if (item.item_type === 'work') {
        // Добавляем стоимость работы (всегда, независимо от наличия материалов)
        const workAmount = item.total_amount || 0;
        worksTotal += workAmount;
        total += workAmount;
        
        // Work cost added to total
        
        // Добавляем стоимость привязанных к работе материалов (если есть)
        if (workLinks[item.id] && workLinks[item.id].length > 0) {
          const materialsTotal = workLinks[item.id].reduce((sum: number, link: any) => {
            const linkTotal = link.calculated_total || 0;
            return sum + linkTotal;
          }, 0);
          linkedMaterialsTotal += materialsTotal;
          total += materialsTotal;
          // Materials linked to this work
        }
      } else if (item.item_type === 'material') {
        // Проверяем, не является ли этот материал связанным
        if (!linkedMaterialIds.has(item.id)) {
          // Это несвязанный материал - добавляем его стоимость
          const materialAmount = item.total_amount || 0;
          unlinkedMaterialsTotal += materialAmount;
          total += materialAmount;
        }
      }
    }
    
    // Total calculation complete
    
    return total;
  };

  // React Query: Optimized positions loading with comprehensive performance monitoring
  const {
    data: positions = [],
    isLoading: positionsLoading,
    error: positionsError,
    refetch: refetchPositions
  } = useQuery({
    queryKey: ['tender-positions', tenderId],
    queryFn: async (): Promise<PositionWithItems[]> => {
      try {
        // Check if this is a cache hit or miss
        const cacheData = queryClient.getQueryData(['tender-positions', tenderId]);
        monitorQueryCache('tender-positions', !!cacheData);

        setLoadingStartTime(performance.now());
        performanceMonitor.start('query-total-execution');
        debugLog('🚀 [REACT QUERY] Loading positions for tender:', tenderId, 'at', new Date().toISOString());

        // Step 1: Load positions with performance tracking
        performanceMonitor.start('API-load-positions');
        const positionsResult = await clientPositionsApi.getByTenderId(tenderId, {}, { limit: 50 });
        performanceMonitor.end('API-load-positions', positionsResult.data?.length);

        if (positionsResult.error) {
          performanceMonitor.fail('API-load-positions', positionsResult.error);
          console.error('❌ Failed to load positions:', positionsResult.error);
          throw new Error(positionsResult.error);
        }

        const positions = positionsResult.data || [];

        if (positions.length === 0) {
          performanceMonitor.end('query-total-execution', 0);
          performanceMonitor.logSummary();
          debugLog('📋 No positions found');
          return [];
        }

        // Step 2: Load BOQ items with performance tracking
        const initialPositionIds = positions.slice(0, 5).map(p => p.id);

        let initialBoqItems: BOQItem[] = [];
        if (initialPositionIds.length > 0) {
          performanceMonitor.start('API-load-boq-items');
          const initialBoqResult = await supabase
            .from('boq_items')
            .select('*')
            .eq('tender_id', tenderId)
            .in('client_position_id', initialPositionIds)
            .order('created_at', { ascending: true });

          if (initialBoqResult.error) {
            performanceMonitor.fail('API-load-boq-items', initialBoqResult.error.message);
            console.error('❌ Failed to load initial BOQ items:', initialBoqResult.error);
            throw new Error(initialBoqResult.error.message);
          }

          initialBoqItems = initialBoqResult.data || [];
          performanceMonitor.end('API-load-boq-items', initialBoqItems.length);
        }

        // Step 3: Load work-material links with performance tracking
        performanceMonitor.start('API-load-work-material-links');
        debugLog('📡 Loading work-material links for initial positions...');
        const allLinksResult = await supabase
          .from('work_material_links')
          .select(`
            *,
            work_item:boq_items!work_boq_item_id(*),
            material_item:boq_items!material_boq_item_id(*)
          `)
          .in('client_position_id', initialPositionIds);

        const allLinks = allLinksResult.error ? [] : (allLinksResult.data || []);
        if (allLinksResult.error) {
          performanceMonitor.fail('API-load-work-material-links', allLinksResult.error.message);
        } else {
          performanceMonitor.end('API-load-work-material-links', allLinks.length);
        }

        // Step 4: Group BOQ items by position with performance tracking
        const groupItemsEnd = measureDataProcessing('group-boq-items', initialBoqItems.length);
        const boqItemsByPosition: Record<string, any[]> = {};
        initialBoqItems.forEach((item) => {
          if (!boqItemsByPosition[item.client_position_id]) {
            boqItemsByPosition[item.client_position_id] = [];
          }
          boqItemsByPosition[item.client_position_id].push(item);
        });
        groupItemsEnd(Object.keys(boqItemsByPosition).length);

        // Update loaded position items state
        setLoadedPositionItems(prev => ({
          ...prev,
          ...boqItemsByPosition
        }));

        // Step 5: Group work-material links with performance tracking
        const groupLinksEnd = measureDataProcessing('group-work-material-links', allLinks.length);
        const linksByPosition: Record<string, Record<string, any[]>> = {};
        allLinks.forEach((link: any) => {
          if (!linksByPosition[link.client_position_id]) {
            linksByPosition[link.client_position_id] = {};
          }

          const workId = link.work_boq_item_id;
          if (!linksByPosition[link.client_position_id][workId]) {
            linksByPosition[link.client_position_id][workId] = [];
          }

          // Calculate material volume and cost
          const workItem = initialBoqItems.find(item => item.id === workId);
          const workVolume = workItem?.quantity || 0;

          const materialVolume = calculateMaterialVolume(
            workVolume,
            link.material_consumption_coefficient || 1,
            link.material_conversion_coefficient || 1
          );

          linksByPosition[link.client_position_id][workId].push({
            ...link,
            calculated_material_volume: materialVolume,
            calculated_total: materialVolume * (link.material_unit_rate || 0)
          });
        });
        groupLinksEnd(Object.values(linksByPosition).length);

        // Step 6: Process positions with pre-loaded data
        const processPositionsEnd = measureDataProcessing('process-positions-with-totals', positions.length);
        const positionsWithItems = positions.map((position) => {
          const positionBoqItems = boqItemsByPosition[position.id] || [];
          const positionWorkLinks = linksByPosition[position.id] || {};

          // Mark if position has loaded items (for UI feedback)
          const hasLoadedItems = positionBoqItems.length > 0 || initialPositionIds.includes(position.id);

          // Calculate total using only works and their linked materials
          const totalCost = calculatePositionTotalCost(
            positionBoqItems.filter(item => !(item as any).is_linked_material), // Only non-linked items
            positionWorkLinks
          );

          debugLog(`💰 Position ${position.position_number} total: ${totalCost}`);

          return {
            ...position,
            boq_items: positionBoqItems,
            total_position_cost: totalCost,
            hasLoadedItems
          };
        });
        processPositionsEnd(positionsWithItems.length);

        // Final performance summary
        performanceMonitor.end('query-total-execution', positionsWithItems.length);
        performanceMonitor.logSummary();

        debugLog('✅ [REACT QUERY] Data loading complete:', {
          positions: positionsWithItems.length,
          initialBoqItems: initialBoqItems.length,
          initialLinks: allLinks.length,
          loadedPositions: initialPositionIds.length
        });

        return positionsWithItems;

      } catch (error) {
        performanceMonitor.fail('query-total-execution', error.message);
        performanceMonitor.logSummary();
        throw error;
      }
    },
    staleTime: 2 * 60 * 1000, // 2 minutes cache
    gcTime: 5 * 60 * 1000, // 5 minutes garbage collection
    enabled: !!tenderId, // Only run if tenderId exists
    retry: 2,
    retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000)
  });


  // Library data is now handled by AutoCompleteSearch component

  // Загрузка курсов валют из тендера
  const loadTenderRates = useCallback(async () => {
    try {
      const result = await tendersApi.getById(tenderId);
      if (result.error) {
        console.error('❌ Error loading tender rates:', result.error);
        return;
      }
      
      if (result.data) {
        setTenderRates({
          usd_rate: result.data.usd_rate || null,
          eur_rate: result.data.eur_rate || null,
          cny_rate: result.data.cny_rate || null
        });
        debugLog('✅ Tender rates loaded:', {
          usd: result.data.usd_rate,
          eur: result.data.eur_rate,
          cny: result.data.cny_rate
        });
      }
    } catch (error) {
      console.error('💥 Exception loading tender rates:', error);
    }
  }, [tenderId]);

  useEffect(() => {
    if (tenderId) {
      loadTenderRates();
    }
  }, [tenderId, loadTenderRates]);

  // Load BOQ items for a specific position (lazy loading)
  const loadBOQItemsForPosition = useCallback(async (positionId: string) => {

    // Skip if already loaded or loading
    if (loadedPositionItems[positionId] || loadingPositionItems[positionId]) {
      monitorQueryCache(`lazy-boq-items-${positionId}`, true);
      return loadedPositionItems[positionId] || [];
    }

    monitorQueryCache(`lazy-boq-items-${positionId}`, false);
    setLoadingPositionItems(prev => ({ ...prev, [positionId]: true }));

    try {
      performanceMonitor.start(`API-lazy-load-boq-items-${positionId}`);
      const result = await supabase
        .from('boq_items')
        .select('*')
        .eq('tender_id', tenderId)
        .eq('client_position_id', positionId)
        .order('created_at', { ascending: true });

      if (result.error) {
        performanceMonitor.fail(`API-lazy-load-boq-items-${positionId}`, result.error.message);
        console.error('❌ Failed to load BOQ items for position:', result.error);
        throw new Error(result.error.message);
      }

      const boqItems = result.data || [];
      performanceMonitor.end(`API-lazy-load-boq-items-${positionId}`, boqItems.length);

      // Update state processing
      const processStateEnd = measureDataProcessing(`process-position-state-${positionId}`, boqItems.length);
      setLoadedPositionItems(prev => ({ ...prev, [positionId]: boqItems }));

      // Update the position in React Query cache
      queryClient.setQueryData(['tender-positions', tenderId], (oldData: PositionWithItems[] | undefined) => {
        if (!oldData) return oldData;

        return oldData.map(position => {
          if (position.id === positionId) {
            const positionWorkLinks = allWorkLinks[positionId] || {};
            const totalCost = calculatePositionTotalCost(
              boqItems.filter(item => !(item as any).is_linked_material),
              positionWorkLinks
            );

            return {
              ...position,
              boq_items: boqItems,
              total_position_cost: totalCost,
              hasLoadedItems: true
            };
          }
          return position;
        });
      });
      processStateEnd();

      return boqItems;
    } catch (error) {
      console.error('💥 Error loading BOQ items for position:', error);
      message.error(`Ошибка загрузки элементов позиции: ${error.message}`);
      return [];
    } finally {
      setLoadingPositionItems(prev => ({ ...prev, [positionId]: false }));
    }
  }, [tenderId, loadedPositionItems, loadingPositionItems, queryClient, allWorkLinks, calculatePositionTotalCost]);

  // Load links for all works in a position
  const loadLinksForPosition = useCallback(async (positionId: string) => {

    // Performance monitoring for entire operation
    performanceMonitor.start(`load-links-for-position-${positionId}`);

    // First, ensure BOQ items are loaded for this position
    await loadBOQItemsForPosition(positionId);

    try {
      // Load work-material links with performance tracking
      performanceMonitor.start(`API-load-work-material-links-${positionId}`);
      const result = await workMaterialLinksApi.getLinksByPosition(positionId);
      performanceMonitor.end(`API-load-work-material-links-${positionId}`, result.data?.length || 0);

      if (result.error) {
        performanceMonitor.fail(`API-load-work-material-links-${positionId}`, result.error);
        console.error('❌ Error loading links:', result.error);
        message.error(`Ошибка загрузки связей: ${result.error}`);
        return;
      }

      if (result.data) {
        // Process links with performance tracking
        const processLinksEnd = measureDataProcessing(`process-links-${positionId}`, result.data.length);

        // Получаем позицию и её работы
        const position = positions.find(p => p.id === positionId);

        // Group links by work ID and update calculations
        const linksByWork: Record<string, any[]> = {};
        result.data.forEach((link: any) => {
          // Находим работу для получения её объема
          const workItem = position?.boq_items?.find(item => item.id === link.work_boq_item_id);
          const workVolume = workItem?.quantity || 0;

          // Рассчитываем объем материала: объем работы * коэффициент расхода * коэффициент перевода
          const materialVolume = calculateMaterialVolume(
            workVolume,
            link.material_consumption_coefficient || 1,
            link.material_conversion_coefficient || 1
          );

          // Обновляем связь с правильным расчетом
          const updatedLink = {
            ...link,
            calculated_material_volume: materialVolume,
            total_material_needed: materialVolume,
            calculated_total: materialVolume * (link.material_unit_rate || 0)
          };

          if (!linksByWork[link.work_boq_item_id]) {
            linksByWork[link.work_boq_item_id] = [];
          }
          linksByWork[link.work_boq_item_id].push(updatedLink);
        });

        processLinksEnd(Object.keys(linksByWork).length);
        setAllWorkLinks(linksByWork);

        // Load fresh hierarchical data with performance tracking
        performanceMonitor.start(`API-load-hierarchical-${positionId}`);
        const freshResult = await boqApi.getHierarchicalByPosition(positionId);
        performanceMonitor.end(`API-load-hierarchical-${positionId}`, freshResult.data?.length || 0);

        if (!freshResult.error && freshResult.data) {
          // Calculate totals with performance tracking
          const calculateTotalsEnd = measureDataProcessing(`calculate-totals-${positionId}`, freshResult.data.length);
          const updatedItems = freshResult.data;

          const newTotalCost = calculatePositionTotalCost(updatedItems, linksByWork);
          const materialsTotal = updatedItems.filter(i => i.item_type === 'material').reduce((sum, i) => sum + (i.total_amount || 0), 0);
          const worksTotal = updatedItems.filter(i => i.item_type === 'work').reduce((sum, i) => sum + (i.total_amount || 0), 0);
          calculateTotalsEnd();

          // Update position totals in database
          performanceMonitor.start(`API-update-position-totals-${positionId}`);
          const updateResult = await clientPositionsApi.update(positionId, {
            total_materials_cost: materialsTotal,
            total_works_cost: worksTotal
          });
          performanceMonitor.end(`API-update-position-totals-${positionId}`, 1);

          if (updateResult.error) {
            performanceMonitor.fail(`API-update-position-totals-${positionId}`, updateResult.error);
            console.error('❌ Failed to update position totals:', updateResult.error);
          } else {
          }

          // Update state with performance tracking
          const updateStateEnd = measureDataProcessing(`update-state-${positionId}`, updatedItems.length);
          setSelectedPosition(prev => {
            if (prev && prev.id === positionId) {
              return {
                ...prev,
                boq_items: updatedItems,
                total_position_cost: newTotalCost,
                total_materials_cost: materialsTotal,
                total_works_cost: worksTotal
              };
            }
            return prev;
          });
          updateStateEnd();

          // Refresh positions data
          performanceMonitor.start(`refetch-positions-${positionId}`);
          await refetchPositions();
          performanceMonitor.end(`refetch-positions-${positionId}`, 1);
        }
      }

      performanceMonitor.end(`load-links-for-position-${positionId}`, result.data?.length || 0);
    } catch (error) {
      performanceMonitor.fail(`load-links-for-position-${positionId}`, error.message);
      console.error('💥 Error loading position links:', error);
    }
  }, [positions, boqApi]);

  // Open/close position
  const openModal = useCallback(async (position: PositionWithItems) => {
    debugLog('📋 Position details in openModal:', {
      id: position.id,
      position_number: position.position_number,
      item_no: position.item_no,
      work_name: position.work_name
    });

    // Performance monitoring for position toggle
    const operationName = selectedPosition?.id !== position.id ? 'open-position' : 'close-position';
    performanceMonitor.start(`${operationName}-${position.id}`);

    if (!position.position_number && position.position_number !== 0) {
      performanceMonitor.fail(`${operationName}-${position.id}`, 'Position missing position_number');
      console.error('❌ Position missing position_number!', position);
      message.error('Ошибка: У позиции отсутствует номер. Пожалуйста, обновите страницу.');
      return;
    }

    try {
      if (selectedPosition?.id !== position.id) {
        debugLog('📂 Opening position:', position.id);
        // Opening a new position - ensure BOQ items are loaded first, then load links
        await loadBOQItemsForPosition(position.id);
        await loadLinksForPosition(position.id);

        // Update state with performance tracking
        const updateStateEnd = measureDataProcessing(`update-selected-position-${position.id}`, 1);
        setSelectedPosition(position);
        updateStateEnd();

        performanceMonitor.end(`open-position-${position.id}`, 1);
      } else {
        debugLog('📁 Closing position:', position.id);
        // Closing current position - clear links
        setSelectedPosition(null);
        setAllWorkLinks({});
        performanceMonitor.end(`close-position-${position.id}`, 1);
      }
    } catch (error) {
      performanceMonitor.fail(`${operationName}-${position.id}`, error.message);
      console.error('💥 Error in openModal:', error);
      message.error('Ошибка при открытии позиции');
    }

    // Reset form data
    setFormData({
      type: 'work',
      name: '',
      unit: 'м²',
      quantity: '',
      price: '',
      consumptionCoefficient: '',
      conversionCoefficient: '',
      selectedItemId: null
    });
  }, [selectedPosition, loadLinksForPosition]);

  const closeModal = useCallback(() => {
    debugLog('❌ Closing modal');
    setSelectedPosition(null);
    setFormData({
      type: 'work',
      name: '',
      unit: 'м²',
      quantity: '',
      price: '',
      consumptionCoefficient: '',
      conversionCoefficient: '',
      selectedItemId: null
    });
  }, []);

  // Handle form input changes
  const handleInputChange = useCallback((field: string, value: string) => {
    debugLog('📝 Form field changed:', { field, value });
    setFormData(prev => {
      const newData = {
        ...prev,
        [field]: value
      };
      
      // Clear name and selected item when type changes
      if (field === 'type') {
        newData.name = '';
        newData.selectedItemId = null;
        newData.unit = 'м²'; // Reset to default unit
      }
      
      return newData;
    });
  }, []);

  // Handle autocomplete selection with auto-fill unit
  const handleItemSelect = useCallback((value: string, option: { id: string; name: string; unit: string }) => {
    setFormData(prev => ({
      ...prev,
      name: option.name,
      unit: option.unit,
      selectedItemId: option.id
    }));
  }, []);

  // Handle name change from autocomplete
  const handleNameChange = useCallback((value: string) => {
    debugLog('📝 Name changed:', value);
    setFormData(prev => ({
      ...prev,
      name: value,
      // Clear selected ID if user types custom name
      selectedItemId: prev.name !== value ? null : prev.selectedItemId
    }));
  }, []);

  // Handle manual volume changes
  const handleManualVolumeChange = useCallback(
    (positionId: string, value: number | null) => {
      debugLog('✏️ handleManualVolumeChange called:', { positionId, value });

      const oldValue = positions.find((p) => p.id === positionId)?.manual_volume ?? null;
      debugLog('🔁 manual volume state change:', {
        positionId,
        oldValue,
        newValue: value,
      });

      // Optimistic update - directly call API and then refresh
      try {
        const result = await clientPositionsApi.update(positionId, { manual_volume: value });

        if (result.error) {
          console.error('❌ manual volume update failed:', result.error);
          message.error('Ошибка сохранения объема');
        } else {
          // Refresh data to reflect changes
          await refetchPositions();
        }
      } catch (error) {
        console.error('💥 Exception updating manual volume:', error);
        message.error('Ошибка сохранения объема');
      }
    },
    [positions]
  );

  // Add new BOQ item with retry logic
  const addItem = useCallback(async () => {
    debugLog('➕ Adding new BOQ item:', formData);
    
    // Для материалов не требуем объем, для работ - требуем
    if (!formData.name || !formData.price || !selectedPosition) {
      message.warning('Заполните наименование и цену');
      return;
    }
    
    if (formData.type === 'work' && !formData.quantity) {
      message.warning('Для работ необходимо указать объем');
      return;
    }

    try {
      debugLog('🚀 Adding new BOQ item to position:', {
        id: selectedPosition.id,
        position_number: selectedPosition.position_number,
        item_no: selectedPosition.item_no,
        work_name: selectedPosition.work_name
      });
      
      // Check if position has valid position_number
      if (!selectedPosition.position_number && selectedPosition.position_number !== 0) {
        console.error('❌ Selected position missing position_number!', selectedPosition);
        message.error('Ошибка: У позиции отсутствует номер. Пожалуйста, обновите страницу.');
        return;
      }

      // Let the API handle sub_number and item_number generation
      // The API will also handle retries in case of duplicates
      
      // Проверяем selectedItemId на пустую строку
      const materialId = formData.type === 'material' && formData.selectedItemId && formData.selectedItemId !== '' 
        ? formData.selectedItemId 
        : null;
      const workId = formData.type === 'work' && formData.selectedItemId && formData.selectedItemId !== '' 
        ? formData.selectedItemId 
        : null;
      
      debugLog('🔍 Form data before creating:', {
        type: formData.type,
        name: formData.name,
        selectedItemId: formData.selectedItemId,
        materialId,
        workId
      });
      
      const newItemData: BOQItemInsert = {
        tender_id: tenderId,
        client_position_id: selectedPosition.id,
        // Don't set item_number and sub_number - let crud.ts generate them
        // item_number and sub_number will be auto-generated
        item_type: formData.type,
        description: formData.name,
        unit: formData.unit,
        quantity: formData.type === 'material' ? 1 : parseFloat(formData.quantity || '0'),
        unit_rate: parseFloat(formData.price),
        consumption_coefficient: formData.type === 'material' && formData.consumptionCoefficient ? parseFloat(formData.consumptionCoefficient) : null,
        conversion_coefficient: formData.type === 'material' && formData.conversionCoefficient ? parseFloat(formData.conversionCoefficient) : null,
        delivery_price_type: formData.type === 'material' ? formData.deliveryPriceType : null,
        delivery_amount: formData.type === 'material' && formData.deliveryPriceType === 'amount' && formData.deliveryAmount ? parseFloat(formData.deliveryAmount) : null,
        material_id: materialId,
        work_id: workId,
        cost_node_id: formData.cost_node_id
      };

      const result = await boqItemsApi.create(newItemData);

      if (result.error) {
        console.error('❌ Create failed:', result.error);
        throw new Error(result.error);
      }

      
      // Use the complete BOQ item returned from the database
      const newBOQItem = result.data;
      if (!newBOQItem) {
        throw new Error('No data returned from create');
      }
      debugLog('🎆 Created BOQ item from database:', newBOQItem);
      
      debugLog('🎆 Adding new item to local state...');
      
      // Get fresh hierarchical BOQ items for the position to ensure we have the latest state
      const freshResult = await boqApi.getHierarchicalByPosition(selectedPosition.id);
      debugLog('📥 Fresh result from API:', freshResult);
      
      const hierarchicalItems = freshResult.error ? [] : (freshResult.data || []);
      
      // Логируем все элементы для отладки
      hierarchicalItems.forEach(item => {
        // Processing item: ${item.item_type}
      });
      
      // Фильтруем только несвязанные элементы (работы и материалы, которые не являются linked)
      const updatedItems = hierarchicalItems.filter(item => !(item as any).is_linked_material);
      
      debugLog('📊 Filtered items (non-linked):', updatedItems.length);
      
      // Проверяем, есть ли новый материал в списке
      const newItemInList = updatedItems.find(item => item.id === newBOQItem.id);
      debugLog('🔎 New item found in list?', newItemInList ? 'YES' : 'NO');
      
      if (newBOQItem.item_type === 'material' && !newItemInList) {
        debugLog('⚠️ New material not found in updated items, adding manually');
        updatedItems.push(newBOQItem);
      }
      
      debugLog('📋 Final updatedItems IDs:', updatedItems.map(i => i.id));
      
      // Calculate total cost including only works and their linked materials
      const newTotalCost = calculatePositionTotalCost(updatedItems, allWorkLinks);
      
      
      // Update position totals in database  
      const materialsTotal = updatedItems.filter(i => i.item_type === 'material').reduce((sum, i) => sum + (i.total_amount || 0), 0);
      const worksTotal = updatedItems.filter(i => i.item_type === 'work').reduce((sum, i) => sum + (i.total_amount || 0), 0);
      
      const updateResult = await clientPositionsApi.update(selectedPosition.id, {
        total_materials_cost: materialsTotal,
        total_works_cost: worksTotal
      });
      
      if (updateResult.error) {
        console.error('❌ Failed to update position totals:', updateResult.error);
      } else {
      }
      
      // Сначала обновляем selectedPosition
      const updatedSelectedPosition = {
        ...selectedPosition,
        boq_items: updatedItems,
        total_position_cost: newTotalCost,
        total_materials_cost: materialsTotal,
        total_works_cost: worksTotal
      };
      
      setSelectedPosition(updatedSelectedPosition);
      
      // Refresh positions via React Query
      await refetchPositions();
      
      debugLog('✅ State updated with new items');
      
      // Если добавлен материал, нужно также обновить allWorkLinks
      // чтобы новый материал не был ошибочно скрыт
      if (newBOQItem.item_type === 'material') {
        // Перезагружаем связи для позиции, чтобы убедиться что новый материал отображается
        await loadLinksForPosition(selectedPosition.id);
      }
      
      message.success(`${formData.type === 'work' ? 'Работа' : 'Материал'} "${formData.name}" добавлена`);
      
      // Clear form - reset all fields
      setFormData({
        type: 'work',
        name: '',
        unit: 'м²',
        quantity: '',
        price: '',
        consumptionCoefficient: '',
        conversionCoefficient: '',
        selectedItemId: null,
        deliveryPriceType: 'included',
        deliveryAmount: '',
        cost_node_id: null,
        cost_node_display: null
      });

      // No need to reload positions - updated locally!
      debugLog('✨ Local state updated, no reload needed');
    } catch (error: any) {
      console.error('💥 Error adding BOQ item:', error);
      message.error(error.message || 'Ошибка при добавлении элемента');
    }
  }, [formData, selectedPosition, tenderId]);

  // Remove BOQ sub-item
  const removeSubItem = useCallback(async (positionId: string, subItemId: string) => {
    debugLog('🗑️ Removing sub-item:', { positionId, subItemId });
    
    try {
      // First find the position and item to delete
      const position = positions.find(p => p.id === positionId);
      const selectedPos = selectedPosition?.id === positionId ? selectedPosition : null;
      const targetPosition = selectedPos || position;
      
      if (!targetPosition) {
        console.error('❌ Position not found in state:', positionId);
        message.error('Ошибка: позиция не найдена');
        return;
      }
      
      // Find the item to delete for the success message
      const deletedItem = targetPosition.boq_items?.find(item => item.id === subItemId);
      if (!deletedItem) {
        console.error('❌ Item to delete not found:', subItemId);
        message.error('Ошибка: элемент не найден');
        return;
      }
      
      // Now delete from database
      const result = await boqItemsApi.delete(subItemId);

      if (result.error) {
        console.error('❌ Delete failed:', result.error);
        throw new Error(result.error);
      }

      
      // Filter out the deleted item from the position's items
      const updatedItems = (targetPosition.boq_items || []).filter(item => item.id !== subItemId);
      
      // If deleted item was a work, also remove its links from allWorkLinks
      if (deletedItem.item_type === 'work') {
        setAllWorkLinks(prev => {
          const newLinks = { ...prev };
          delete newLinks[subItemId];
          return newLinks;
        });
      }
      
      // Calculate total cost including only works and their linked materials
      const newTotalCost = calculatePositionTotalCost(updatedItems, allWorkLinks);
      
      
      // Update position totals in database
      const materialsTotal = updatedItems.filter(i => i.item_type === 'material').reduce((sum, i) => sum + (i.total_amount || 0), 0);
      const worksTotal = updatedItems.filter(i => i.item_type === 'work').reduce((sum, i) => sum + (i.total_amount || 0), 0);
      
      const updateResult = await clientPositionsApi.update(positionId, {
        total_materials_cost: materialsTotal,
        total_works_cost: worksTotal
      });
      
      if (updateResult.error) {
        console.error('❌ Failed to update position totals:', updateResult.error);
      } else {
      }
      
      // Update both selectedPosition and positions
      const updatedPosition = {
        ...targetPosition,
        boq_items: updatedItems,
        total_position_cost: newTotalCost
      };
      
      // Update selectedPosition if it's the same position
      if (selectedPosition?.id === positionId) {
        setSelectedPosition(updatedPosition);
      }
      
      // Refresh positions via React Query
      await refetchPositions();
      
      // Show success message
      message.success(`${deletedItem?.item_type === 'work' ? 'Работа' : 'Материал'} успешно удален${deletedItem?.item_type === 'work' ? 'а' : ''}`);
      
      debugLog('✅ UI updated after deletion');
      debugLog('✨ Local state updated after deletion, no reload needed');
    } catch (error) {
      console.error('💥 Delete error:', error);
      message.error('Ошибка удаления элемента');
    }
  }, [positions, selectedPosition, allWorkLinks]);

  // Update BOQ sub-item
  const updateSubItem = useCallback(async (item: BOQItem, updates?: Partial<BOQItem>) => {
    // If no updates provided, open edit modal inline
    if (!updates) {
      debugLog('✏️ Opening inline edit for:', item);
      setEditingItem(item);
      
      // Initialize form data with all fields for materials
      if (item.item_type === 'material') {
        setEditFormData({
          description: item.description || '',
          quantity: item.quantity || 1,
          unit_rate: item.unit_rate || 0,
          consumption_coefficient: item.consumption_coefficient || 1,
          conversion_coefficient: item.conversion_coefficient || 1,
          delivery_price_type: item.delivery_price_type || 'included',
          delivery_amount: item.delivery_amount || 0,
          cost_node_id: (item as any).cost_node_id || null,
          cost_node_display: (item as any).cost_node_display || null,
          currency_type: item.currency_type || 'RUB',
          currency_rate: item.currency_rate || null
        });
      } else {
        // For works, use simpler form
        setEditFormData({
          description: item.description || '',
          quantity: item.quantity || 0,
          unit_rate: item.unit_rate || 0,
          cost_node_id: (item as any).cost_node_id || null,
          cost_node_display: (item as any).cost_node_display || null,
          currency_type: item.currency_type || 'RUB',
          currency_rate: item.currency_rate || null
        });
      }
      return;
    }
    
    debugLog('✏️ Updating sub-item:', { itemId: item.id, updates });
    
    try {
      const result = await boqItemsApi.update(item.id, updates);

      if (result.error) {
        console.error('❌ Update failed:', result.error);
        throw new Error(result.error);
      }

      
      // Update local state immediately with calculated total_amount
      const positionId = item.client_position_id;
      
      // Find current position
      const currentPosition = positions.find(p => p.id === positionId);
      if (!currentPosition) return;
      
      // Update the item locally with calculated total_amount
      const updatedItems = currentPosition.boq_items?.map(boqItem => {
        if (boqItem.id === item.id) {
          // Calculate new total_amount based on quantity and unit_rate
          const newQuantity = updates.quantity !== undefined ? updates.quantity : boqItem.quantity;
          const newUnitRate = updates.unit_rate !== undefined ? updates.unit_rate : boqItem.unit_rate;
          const newTotalAmount = (newQuantity || 0) * (newUnitRate || 0);
          
          return {
            ...boqItem,
            ...updates,
            total_amount: newTotalAmount
          };
        }
        return boqItem;
      }) || [];
      
      // Calculate total cost including only works and their linked materials
      const newTotalCost = calculatePositionTotalCost(updatedItems, allWorkLinks);
      
      // Update position totals in database
      const materialsTotal = updatedItems.filter(i => i.item_type === 'material').reduce((sum, i) => sum + (i.total_amount || 0), 0);
      const worksTotal = updatedItems.filter(i => i.item_type === 'work').reduce((sum, i) => sum + (i.total_amount || 0), 0);
      
      const updateResult = await clientPositionsApi.update(positionId, {
        total_materials_cost: materialsTotal,
        total_works_cost: worksTotal
      });
      
      if (updateResult.error) {
        console.error('❌ Failed to update position totals:', updateResult.error);
      } else {
        debugLog('✅ Position totals updated in database after edit');
      }
      
      // Refresh positions via React Query
      await refetchPositions();
      
      // Update selectedPosition if it matches the edited item's position
      setSelectedPosition(prev => {
        if (prev && prev.id === positionId) {
          return {
            ...prev,
            boq_items: updatedItems,
            total_position_cost: newTotalCost
          };
        }
        return prev;
      });
      
      message.success('Элемент обновлен');
      
      // No need to reload positions - updated locally!
      debugLog('✨ Local state updated after edit, no reload needed');
    } catch (error) {
      console.error('💥 Update error:', error);
      message.error('Ошибка обновления элемента');
    }
  }, [positions, allWorkLinks, calculatePositionTotalCost, clientPositionsApi, boqItemsApi]);

  // Save edited item
  const handleSaveEdit = useCallback(async () => {
    if (!editingItem) return;
    
    
    // Валидация курса валюты
    if (editFormData.currency_type !== 'RUB' && !editFormData.currency_rate) {
      message.error(`Не задан курс для ${editFormData.currency_type}. Обновите курсы валют в настройках тендера.`);
      return;
    }
    
    try {
      // Рассчитываем total_amount на клиенте
      const totalAmount = calculateTotalAmount({
        item_type: editingItem.item_type,
        unit_rate: editFormData.unit_rate,
        quantity: editFormData.quantity,
        currency_type: editFormData.currency_type,
        currency_rate: editFormData.currency_rate,
        delivery_price_type: editFormData.delivery_price_type,
        delivery_amount: editFormData.delivery_amount
      });
      
      const updates: Partial<BOQItem> = {
        description: editFormData.description,
        quantity: editFormData.quantity,
        unit_rate: editFormData.unit_rate,
        currency_type: editFormData.currency_type || 'RUB',
        currency_rate: editFormData.currency_rate,
        total_amount: totalAmount
      };
      
      // Call the update function with updates
      await updateSubItem(editingItem, updates);
      
      // Close edit modal
      setEditingItem(null);
      setEditFormData({
        description: '',
        quantity: 0,
        unit_rate: 0,
        currency_type: 'RUB'
      });
      
    } catch (error) {
      console.error('💥 Save edit error:', error);
      message.error('Ошибка сохранения изменений');
    }
  }, [editingItem, editFormData, updateSubItem, calculateTotalAmount]);

  // Handle update for BOQ item (materials with all fields)
  const handleUpdateBOQItem = useCallback(async () => {
    if (!editingItem) return;
    
    debugLog('💾 Saving edited BOQ item:', editingItem.id);
    
    // Валидация курса валюты
    if (editFormData.currency_type !== 'RUB' && !editFormData.currency_rate) {
      message.error(`Не задан курс для ${editFormData.currency_type}. Обновите курсы валют в настройках тендера.`);
      return;
    }
    
    try {
      // Рассчитываем total_amount на клиенте
      const totalAmount = calculateTotalAmount({
        item_type: editingItem.item_type,
        unit_rate: editFormData.unit_rate,
        quantity: editFormData.quantity,
        currency_type: editFormData.currency_type,
        currency_rate: editFormData.currency_rate,
        delivery_price_type: editFormData.delivery_price_type,
        delivery_amount: editFormData.delivery_amount
      });
      
      // Prepare updates based on item type
      const updates: Partial<BOQItem> = {
        description: editFormData.description,
        quantity: editFormData.quantity,
        unit_rate: editFormData.unit_rate,
        cost_node_id: editFormData.cost_node_id,
        currency_type: editFormData.currency_type || 'RUB',
        currency_rate: editFormData.currency_rate,
        total_amount: totalAmount
      } as any;
      
      // Add material-specific fields
      if (editingItem.item_type === 'material') {
        updates.consumption_coefficient = editFormData.consumption_coefficient || 1;
        updates.conversion_coefficient = editFormData.conversion_coefficient || 1;
        updates.delivery_price_type = editFormData.delivery_price_type || 'included';
        updates.delivery_amount = editFormData.delivery_price_type === 'amount' ? (editFormData.delivery_amount || 0) : null;
      }
      
      // Call the update function with updates
      await updateSubItem(editingItem, updates);
      
      // Close edit modal
      setEditingItem(null);
      setEditFormData({
        description: '',
        quantity: 0,
        unit_rate: 0,
        consumption_coefficient: 1,
        conversion_coefficient: 1,
        delivery_price_type: 'included',
        delivery_amount: 0,
        currency_type: 'RUB'
      });
      
    } catch (error) {
      console.error('💥 Save edit error:', error);
      message.error('Ошибка сохранения изменений');
    }
  }, [editingItem, editFormData, updateSubItem, calculateTotalAmount]);

  // Открытие модального окна для перемещения материала
  const openMoveModal = useCallback((materialId: string, materialName: string, currentWorkId: string | null = null, isLinked: boolean = false, linkId?: string) => {
    
    // Найдем название текущей работы если материал привязан
    let currentWorkName = '';
    if (currentWorkId && selectedPosition) {
      const work = selectedPosition.boq_items?.find(item => item.id === currentWorkId);
      if (work) {
        currentWorkName = work.description || '';
      }
    }
    
    setMoveModal({
      visible: true,
      materialId,
      materialName,
      currentWorkId,
      currentWorkName,
      isLinkedMaterial: isLinked,
      linkId
    });
  }, [selectedPosition]);

  // Обработка перемещения материала в выбранную работу
  const handleMoveMaterial = useCallback(async (targetWorkId: string) => {
    if (!moveModal.materialId || !selectedPosition) return;
    
    // Moving material to work
    
    try {
      if (moveModal.isLinkedMaterial && moveModal.currentWorkId) {
        // Перемещение уже связанного материала
        if (moveModal.linkId) {
          // Обновляем существующую связь
          const updateResult = await workMaterialLinksApi.updateLink(moveModal.linkId, {
            work_boq_item_id: targetWorkId
          });
          
          if (updateResult.error) {
            throw new Error(updateResult.error);
          }
          
          message.success(`Материал "${moveModal.materialName}" перемещен`);
        }
      } else {
        // Создание новой связи для несвязанного материала
        const linkData = {
          client_position_id: selectedPosition.id,
          work_boq_item_id: targetWorkId,
          material_boq_item_id: moveModal.materialId
        };
        
        const createResult = await workMaterialLinksApi.createLink(linkData);
        
        if (createResult.error) {
          throw new Error(createResult.error);
        }
        
        message.success(`Материал "${moveModal.materialName}" привязан к работе`);
      }
      
      // Перезагружаем связи для обновления UI
      await loadLinksForPosition(selectedPosition.id);
      
      // Закрываем модальное окно
      setMoveModal({
        visible: false,
        materialId: null,
        materialName: '',
        currentWorkId: null,
        currentWorkName: '',
        isLinkedMaterial: false
      });
      
    } catch (error) {
      console.error('❌ Move error:', error);
      message.error('Ошибка перемещения материала');
    }
  }, [moveModal, selectedPosition, loadLinksForPosition]);

  // Обработка перетаскивания материала на работу (оставляем для обратной совместимости)
  const handleDragEnd = useCallback(async (event: DragEndEvent) => {
    const { active, over } = event;
    
    if (!over || !active) return;
    
    // Получаем данные перетаскиваемого элемента и целевого элемента
    const activeData = active.data.current;
    const overData = over.data.current;
    
    // Check for Ctrl/Cmd key for copy mode
    const isCopy = (event as any).activatorEvent?.ctrlKey || (event as any).activatorEvent?.metaKey;
    
    debugLog('🎯 Drag end:', {
      active: activeData,
      over: overData,
      activeId: active.id,
      overId: over.id,
      isCopy
    });
    
    // Проверяем, что материал перетаскивается на работу
    if (activeData?.type === 'material' && overData?.type === 'work') {
      const materialItem = activeData.item as BOQItem;
      const workItem = overData.item as BOQItem;
      
      // Check if this is a linked material being moved between works
      if (activeData.isLinkedMaterial && activeData.sourceWorkId && activeData.sourceWorkId !== workItem.id) {
        await handleMaterialTransferBetweenWorks(
          activeData.sourceWorkId,
          workItem.id,
          materialItem.id,
          activeData.linkId,
          isCopy
        );
        return;
      }
      
      // Находим позицию для получения manual_volume
      const position = positions.find(p => 
        p.boq_items?.some(item => item.id === workItem.id)
      );
      
      if (!position) {
        message.error('Не удалось найти позицию для работы');
        return;
      }
      
      // Creating link between material and work
      
      // Создаем связь между материалом и работой
      const result = await workMaterialLinksApi.createLink({
        client_position_id: position.id,
        work_boq_item_id: workItem.id,
        material_boq_item_id: materialItem.id
      });
      
      if (result.error) {
        // Проверяем, не существует ли уже связь
        if (result.error.includes('duplicate') || result.error.includes('already exists')) {
          message.warning('Связь между этим материалом и работой уже существует');
        } else {
          message.error(`Ошибка создания связи: ${result.error}`);
        }
      } else {
        message.success('Материал успешно привязан к работе');
        
        // Обновляем объем материала на основе объема конкретной работы
        const calculatedVolume = (workItem.quantity || 0) * 
                                (materialItem.consumption_coefficient || 1) * 
                                (materialItem.conversion_coefficient || 1);
        
        debugLog('📊 Calculated material volume:', {
          work_volume: workItem.quantity,
          consumption_coefficient: materialItem.consumption_coefficient,
          conversion_coefficient: materialItem.conversion_coefficient,
          result: calculatedVolume
        });
        
        // Перезагружаем связи и элементы позиции для обновления UI
        await loadLinksForPosition(position.id);
      }
    } else if (activeData?.type === 'material' && overData?.type === 'material') {
      // Перемещение материала в списке (изменение порядка)
      // TODO: Реализовать изменение порядка если необходимо
    }
  }, [positions, loadLinksForPosition, refetchPositions]);

  // Handle material transfer between works
  const handleMaterialTransferBetweenWorks = useCallback(async (
    sourceWorkId: string,
    targetWorkId: string,
    materialId: string,
    linkId: string,
    isCopy: boolean = false
  ) => {
    debugLog('🚀 handleMaterialTransferBetweenWorks called:', {
      sourceWorkId,
      targetWorkId,
      materialId,
      linkId,
      isCopy
    });
    
    try {
      // Call RPC function to move material
      const { data, error } = await supabase
        .rpc('rpc_move_material', {
          p_source_work: sourceWorkId,
          p_target_work: targetWorkId,
          p_material: materialId,
          p_new_index: 0,
          p_mode: isCopy ? 'copy' : 'move'
        });
      
      
      if (error) {
        console.error('❌ RPC error:', error);
        message.error('Ошибка перемещения материала');
        return;
      }
      
      // Check if there's a conflict
      if (data && data.conflict) {
        debugLog('⚠️ Conflict detected, showing modal');
        
        // Get names for display
        const sourceWork = selectedPosition?.boq_items?.find(i => i.id === sourceWorkId);
        const targetWork = selectedPosition?.boq_items?.find(i => i.id === targetWorkId);
        const material = selectedPosition?.boq_items?.find(i => i.id === materialId);
        
        setConflictModal({
          visible: true,
          srcId: data.src_id,
          tgtId: data.tgt_id,
          targetWorkId: targetWorkId,
          materialName: material?.description || 'Материал',
          sourceworkName: sourceWork?.description || 'Работа А',
          targetWorkName: targetWork?.description || 'Работа Б'
        });
      } else if (data && data.ok) {
        message.success(isCopy ? 'Материал скопирован' : 'Материал перемещен');
        
        // Reload links for the position - this will also update BOQ items now
        if (selectedPosition) {
          await loadLinksForPosition(selectedPosition.id);
        }
      }
    } catch (error) {
      console.error('💥 Exception in material transfer:', error);
      message.error('Ошибка при перемещении материала');
    }
  }, [selectedPosition, loadLinksForPosition, boqApi, calculatePositionTotalCost, allWorkLinks]);

  // Handle conflict resolution
  const handleConflictResolution = useCallback(async () => {
    debugLog('🚀 handleConflictResolution called:', {
      conflictModal,
      conflictStrategy
    });
    
    if (!conflictModal.srcId || !conflictModal.tgtId || !conflictModal.targetWorkId) {
      console.error('❌ Missing conflict data');
      return;
    }
    
    try {
      const { data, error } = await supabase
        .rpc('rpc_resolve_conflict', {
          p_src_id: conflictModal.srcId,
          p_tgt_id: conflictModal.tgtId,
          p_target_work: conflictModal.targetWorkId,
          p_strategy: conflictStrategy
        });
      
      
      if (error) {
        console.error('❌ Conflict resolution error:', error);
        message.error('Ошибка разрешения конфликта');
      } else if (data && data.ok) {
        message.success(
          conflictStrategy === 'sum' 
            ? 'Объемы материалов суммированы' 
            : 'Материал заменен'
        );
        
        // Close modal
        setConflictModal({
          visible: false,
          srcId: null,
          tgtId: null,
          targetWorkId: null,
          materialName: '',
          sourceworkName: '',
          targetWorkName: ''
        });
        
        // Reload links and update UI - loadLinksForPosition now updates BOQ items too
        if (selectedPosition) {
          await loadLinksForPosition(selectedPosition.id);
        }
      }
    } catch (error) {
      console.error('💥 Exception in conflict resolution:', error);
      message.error('Ошибка при разрешении конфликта');
    }
  }, [conflictModal, conflictStrategy, selectedPosition, loadLinksForPosition, boqApi, calculatePositionTotalCost, allWorkLinks]);

  const handleDeleteLink = useCallback(async (linkId: string) => {
    
    const result = await workMaterialLinksApi.deleteLink(linkId);
    
    if (result.error) {
      message.error('Ошибка удаления связи');
    } else {
      message.success('Связь удалена');
      
      // Обновляем allWorkLinks для отображения в карточке
      if (selectedPosition) {
        await loadLinksForPosition(selectedPosition.id);
      }
    }
  }, [selectedPosition, loadLinksForPosition]);

  // Удаление материала полностью (из связей и из BOQ)
  const handleDeleteMaterial = useCallback(async (materialId: string, linkId: string, materialName: string) => {
    debugLog('🚀 Deleting material completely:', { materialId, linkId, materialName });
    
    try {
      // 1. Сначала удаляем связь
      const linkDeleteResult = await workMaterialLinksApi.deleteLink(linkId);
      
      if (linkDeleteResult.error) {
        console.error('❌ Failed to delete link:', linkDeleteResult.error);
        message.error('Ошибка удаления связи материала');
        return;
      }
      
      
      // 2. Затем удаляем сам материал из BOQ
      debugLog('🗑️ Step 2: Deleting material from BOQ...');
      const materialDeleteResult = await boqItemsApi.delete(materialId);
      
      if (materialDeleteResult.error) {
        console.error('❌ Failed to delete material:', materialDeleteResult.error);
        message.error('Ошибка удаления материала');
        return;
      }
      
      message.success(`Материал "${materialName}" удален`);
      
      // 3. Обновляем состояние локально
      if (selectedPosition) {
        
        // Удаляем материал из списка BOQ items
        const updatedItems = selectedPosition.boq_items?.filter(item => item.id !== materialId) || [];
        
        // Пересчитываем общую стоимость
        const newTotalCost = calculatePositionTotalCost(updatedItems, allWorkLinks);
        
        // Обновляем totals в базе данных
        const materialsTotal = updatedItems.filter(i => i.item_type === 'material').reduce((sum, i) => sum + (i.total_amount || 0), 0);
        const worksTotal = updatedItems.filter(i => i.item_type === 'work').reduce((sum, i) => sum + (i.total_amount || 0), 0);
        
        await clientPositionsApi.update(selectedPosition.id, {
          total_materials_cost: materialsTotal,
          total_works_cost: worksTotal
        });
        
        // Обновляем selectedPosition
        const updatedSelectedPosition = {
          ...selectedPosition,
          boq_items: updatedItems,
          total_position_cost: newTotalCost,
          total_materials_cost: materialsTotal,
          total_works_cost: worksTotal
        };
        
        setSelectedPosition(updatedSelectedPosition);
        
        // Refresh positions via React Query
        await refetchPositions();
        
        // Обновляем связи для отображения
        await loadLinksForPosition(selectedPosition.id);
        
        debugLog('✨ State updated after material deletion');
      }
      
    } catch (error) {
      console.error('💥 Exception in handleDeleteMaterial:', error);
      message.error('Ошибка удаления материала');
    }
  }, [selectedPosition, workMaterialLinksApi, boqItemsApi, calculatePositionTotalCost, clientPositionsApi, allWorkLinks, loadLinksForPosition]);

  // Update linked material
  const handleUpdateLinkedMaterial = useCallback(async (linkId: string, materialId: string) => {
    
    try {
      // Обновляем сам материал
      if (editingLinkData.consumption_coefficient !== undefined || 
          editingLinkData.conversion_coefficient !== undefined ||
          editingLinkData.unit_rate !== undefined) {
        
        const materialUpdates: any = {};
        if (editingLinkData.consumption_coefficient !== undefined) {
          materialUpdates.consumption_coefficient = editingLinkData.consumption_coefficient;
        }
        if (editingLinkData.conversion_coefficient !== undefined) {
          materialUpdates.conversion_coefficient = editingLinkData.conversion_coefficient;
        }
        if (editingLinkData.unit_rate !== undefined) {
          materialUpdates.unit_rate = editingLinkData.unit_rate;
        }
        
        const result = await boqItemsApi.update(materialId, materialUpdates);
        
        if (result.error) {
          message.error('Ошибка обновления материала');
          return;
        }
      }
      
      message.success('Материал обновлен');
      setEditingLinkId(null);
      setEditingLinkData({});
      
      // Обновляем связи для позиции
      if (selectedPosition) {
        await loadLinksForPosition(selectedPosition.id);
      }
    } catch (error) {
      console.error('❌ Error updating material:', error);
      message.error('Ошибка обновления материала');
    }
  }, [selectedPosition, loadLinksForPosition, editingLinkData]);

  // Calculate totals
  const totalProject = positions.reduce((sum, position) => sum + (position.total_position_cost || 0), 0);

  // Handle React Query error state
  if (positionsError) {
    console.error('💥 React Query error loading positions:', positionsError);
    return (
      <div className="min-h-screen bg-gray-50 p-6 flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-500 text-lg mb-4">
            Ошибка загрузки позиций
          </div>
          <Button
            type="primary"
            onClick={() => refetchPositions()}
            icon={<ReloadOutlined />}
          >
            Попробовать снова
          </Button>
        </div>
      </div>
    );
  }

  if (positionsLoading) {
    const elapsed = loadingStartTime ? (performance.now() - loadingStartTime) / 1000 : 0;
    return (
      <div className="min-h-screen bg-gray-50 p-6 flex items-center justify-center">
        <div className="text-center">
          <Spin size="large" />
          <div className="mt-4 text-gray-600">
            Загружаем позиции заказчика...
          </div>
          {elapsed > 0 && (
            <div className="mt-2 text-sm text-blue-600">
              {elapsed.toFixed(1)}с • Оптимизированная загрузка
            </div>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 p-2">
      <div className="max-w-6xl mx-auto">
        {/* Ультра-компактный заголовок */}
        <div className="bg-blue-600 text-white px-3 py-2 rounded-lg mb-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <h1 className="text-lg font-bold">ВОР</h1>
              <span className="text-blue-100 text-xs">
                Позиций: {positions.length} |
                Загружено: {Object.keys(loadedPositionItems).length}/{positions.length} |
                Элементов: {positions.reduce((sum, p) => sum + (p.boq_items?.length || 0), 0)}
              </span>
            </div>
            <div className="flex items-center gap-2">
              <span className="text-xs text-blue-100">Итого:</span>
              <span className="text-lg font-bold">{formatCurrency(totalProject)}</span>
            </div>
          </div>
        </div>

        {/* Карточки позиций - уменьшенный отступ */}
        <div className="grid grid-cols-1 gap-2">
          {positions.map((position) => {
            const positionItems = position.boq_items || [];
            const positionTotal = position.total_position_cost || 0;
            
            // Логируем для отладки отображения
            debugLog('📝 Position items count:', positionItems.length);
            
            if (selectedPosition?.id === position.id) {
              debugLog('📝 Selected position items:', positionItems.map(i => ({
                id: i.id,
                type: i.item_type,
                desc: i.description,
                is_linked: (i as any).is_linked_material,
                amount: i.total_amount
              })));
            }

            return (
              <div
                key={position.id}
                className={`bg-white rounded-lg shadow-md border border-gray-200 transition-all duration-300 ${
                  selectedPosition?.id === position.id ? 'ring-2 ring-blue-500 shadow-lg' : ''
                }`}
              >
                {/* Заголовок карточки - ультра-компактный */}
                <div 
                  className="p-3 cursor-pointer hover:bg-gray-50 transition-colors"
                  onClick={() => selectedPosition?.id === position.id ? setSelectedPosition(null) : openModal(position)}
                >
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <h3 className="text-sm font-semibold text-gray-900">
                          {position.item_no}. {position.work_name}
                        </h3>
                        {position.unit && (
                          <>
                            <span
                              className="text-xs text-gray-500"
                              onClick={(e) => {
                                e.stopPropagation();
                                debugLog('🖱️ Original volume display clicked for position:', position.id);
                              }}
                            >
                              ({formatQuantity(position.volume ?? 0)} {position.unit})
                            </span>
                            <div className="flex items-center gap-1">
                              <InputNumber
                                size="small"
                                min={0}
                                value={position.manual_volume ?? undefined}
                                placeholder="Ручной объём"
                                className="w-20"
                                onChange={(value) =>
                                  handleManualVolumeChange(position.id, value as number | null)
                                }
                                onClick={(e) => {
                                  e.stopPropagation();
                                  debugLog('🖱️ Manual volume input clicked for position:', position.id);
                                }}
                              />
                              <span
                                className="text-xs text-gray-500"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  debugLog('🖱️ Manual volume unit clicked for position:', position.id);
                                }}
                              >
                                {position.unit}
                              </span>
                            </div>
                          </>
                        )}
                      </div>
                      {position.client_note && (
                        <p className="text-xs text-gray-500 mt-0.5">
                          Прим: {position.client_note}
                        </p>
                      )}
                    </div>
                    <div className="flex items-center gap-3 ml-4">
                      {loadingPositionItems[position.id] && (
                        <div className="flex items-center gap-2">
                          <Spin size="small" />
                          <span className="text-xs text-blue-600">Загрузка...</span>
                        </div>
                      )}
                      <div className="text-right">
                        <div className="text-xs text-gray-500">
                          {positionItems.length > 0 ? `${positionItems.length} поз.` : (position.hasLoadedItems ? 'Пусто' : 'Не загружено')}
                        </div>
                        <div className="text-sm font-bold text-blue-600">
                          {formatCurrency(positionTotal)}
                        </div>
                      </div>
                      {selectedPosition?.id === position.id ? (
                        <CloseOutlined style={{ fontSize: '16px', color: '#9CA3AF' }} />
                      ) : (
                        <EditOutlined style={{ fontSize: '16px', color: '#9CA3AF' }} />
                      )}
                    </div>
                  </div>
                </div>

                {/* Развернутая форма внутри карточки - ультра-компактная */}
                {selectedPosition?.id === position.id && (
                  <div className="border-t bg-gray-50">
                    <div className="p-3">
                      {/* Список существующих позиций с drag-and-drop */}
                      {positionItems.length > 0 && (
                        <div className="mb-3">
                          <h4 className="font-medium mb-2 text-sm text-gray-700">
                            Добавленные позиции:
                            <span className="ml-2 text-xs text-gray-500 font-normal">
                              (перетащите материал на работу для создания связи)
                            </span>
                          </h4>
                              <div className="space-y-1">
                                {positionItems.map((subItem, index) => {
                                  // Проверяем, не является ли этот материал привязанным к какой-либо работе
                                  // Используем флаг is_linked_material из API вместо проверки allWorkLinks
                                  if ((subItem as any).is_linked_material) {
                                    // Этот материал уже отображается под работой, не показываем его отдельно
                                    return null;
                                  }
                                  
                                  // Дополнительная проверка через allWorkLinks для обратной совместимости
                                  if (subItem.item_type === 'material' && Object.keys(allWorkLinks).length > 0) {
                                    const isLinkedMaterial = Object.values(allWorkLinks).some((links: any) => 
                                      links.some((link: any) => link.material_boq_item_id === subItem.id)
                                    );
                                    
                                    if (isLinkedMaterial) {
                                      return null;
                                    }
                                  }
                                  
                                  // Рассчитываем общую стоимость материалов для работы
                                  let linkedMaterialsTotal = 0;
                                  if (subItem.item_type === 'work' && allWorkLinks[subItem.id]) {
                                    linkedMaterialsTotal = allWorkLinks[subItem.id].reduce((sum: number, link: any) => {
                                      return sum + (link.calculated_total || 0);
                                    }, 0);
                                  }
                                  
                                  return (
                                  <div key={subItem.id}>
                                    {subItem.item_type === 'work' ? (
                                      // Работы
                                      <div className="bg-white rounded border border-gray-300 mb-2">
                                        <div className="p-2 bg-gray-50 border-b border-gray-200">
                                          {editingItem?.id === subItem.id ? (
                                            // Inline edit form
                                            <div className="space-y-2">
                                              <div className="flex items-center gap-2">
                                                <input
                                                  type="text"
                                                  value={editFormData.description}
                                                  onChange={(e) => setEditFormData({...editFormData, description: e.target.value})}
                                                  className="flex-1 px-2 py-1 text-sm border border-gray-300 rounded"
                                                  placeholder="Название работы"
                                                />
                                              </div>
                                              <div className="flex items-center gap-2">
                                                <input
                                                  type="number"
                                                  value={editFormData.quantity}
                                                  onChange={(e) => setEditFormData({...editFormData, quantity: parseFloat(e.target.value) || 0})}
                                                  className="w-24 px-2 py-1 text-sm border border-gray-300 rounded"
                                                  placeholder="Кол-во"
                                                />
                                                <span className="text-xs text-gray-500">{subItem.unit}</span>
                                                <Select
                                                  size="small"
                                                  value={editFormData.currency_type || 'RUB'}
                                                  onChange={(value) => {
                                                    const rate = value !== 'RUB' ? tenderRates[`${value.toLowerCase()}_rate`] : null;
                                                    setEditFormData({
                                                      ...editFormData, 
                                                      currency_type: value,
                                                      currency_rate: rate
                                                    });
                                                  }}
                                                  className="w-20"
                                                  onClick={(e) => e.stopPropagation()}
                                                >
                                                  {CURRENCY_OPTIONS.map(opt => (
                                                    <Select.Option key={opt.value} value={opt.value}>
                                                      {opt.symbol}
                                                    </Select.Option>
                                                  ))}
                                                </Select>
                                                <input
                                                  type="number"
                                                  value={editFormData.unit_rate}
                                                  onChange={(e) => setEditFormData({...editFormData, unit_rate: parseFloat(e.target.value) || 0})}
                                                  className="w-32 px-2 py-1 text-sm border border-gray-300 rounded"
                                                  placeholder="Цена за ед."
                                                  step="0.01"
                                                />
                                                {editFormData.currency_type !== 'RUB' && editFormData.currency_rate && (
                                                  <Tooltip title={`Курс: 1${CURRENCY_SYMBOLS[editFormData.currency_type]} = ${editFormData.currency_rate}₽`}>
                                                    <span className="text-xs text-gray-500">
                                                      = {formatCurrency(editFormData.unit_rate * editFormData.currency_rate)}
                                                    </span>
                                                  </Tooltip>
                                                )}
                                                <span className="text-sm font-semibold text-green-600">
                                                  Σ {formatCurrency(calculateTotalAmount({
                                                    item_type: subItem.item_type,
                                                    unit_rate: editFormData.unit_rate,
                                                    quantity: editFormData.quantity,
                                                    currency_type: editFormData.currency_type,
                                                    currency_rate: editFormData.currency_rate,
                                                    delivery_price_type: editFormData.delivery_price_type,
                                                    delivery_amount: editFormData.delivery_amount
                                                  }))}
                                                </span>
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleSaveEdit();
                                                  }}
                                                  className="text-green-500 hover:text-green-700 p-1"
                                                >
                                                  ✓
                                                </button>
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    setEditingItem(null);
                                                  }}
                                                  className="text-gray-500 hover:text-gray-700 p-1"
                                                >
                                                  ✕
                                                </button>
                                              </div>
                                              <div className="flex items-center gap-2">
                                                <label className="text-xs text-gray-600">Затраты:</label>
                                                <div className="flex-1">
                                                  <CostCascadeSelector
                                                    value={editFormData.cost_node_id}
                                                    onChange={(costNodeId, displayValue) => {
                                                      setEditFormData({
                                                        ...editFormData,
                                                        cost_node_id: costNodeId,
                                                        cost_node_display: displayValue
                                                      });
                                                    }}
                                                    placeholder="Выберите категорию затрат"
                                                    style={{ fontSize: '12px' }}
                                                  />
                                                </div>
                                              </div>
                                            </div>
                                          ) : (
                                            // Normal display
                                            <div className="flex items-center justify-between">
                                              <div className="flex-1">
                                                <div className="flex items-center gap-2">
                                                  <span className="text-sm font-semibold">🔧 {subItem.description}</span>
                                                  <span className="text-xs text-gray-500">
                                                    {subItem.quantity} {subItem.unit} × {formatPriceWithCurrency(subItem.unit_rate || 0, subItem.currency_type)}/{subItem.unit}
                                                  </span>
                                                </div>
                                              </div>
                                              <div className="flex items-center gap-2">
                                                <span className="text-sm font-bold text-green-600">
                                                  {formatCurrency(subItem.total_amount || 0)}
                                                </span>
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    updateSubItem(subItem);
                                                  }}
                                                  className="text-blue-500 hover:text-blue-700 p-1"
                                                >
                                                  <EditOutlined style={{ fontSize: '14px' }} />
                                                </button>
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  removeSubItem(position.id, subItem.id);
                                                }}
                                                className="text-red-500 hover:text-red-700 p-1"
                                              >
                                                <CloseOutlined style={{ fontSize: '14px' }} />
                                              </button>
                                              </div>
                                            </div>
                                          )}
                                        </div>
                                        {/* Отображение связанных материалов для работ */}
                                        {allWorkLinks[subItem.id] && allWorkLinks[subItem.id].length > 0 && (
                                  <div className="ml-6 mt-1 p-2 bg-blue-50 rounded border-l-2 border-blue-300">
                                    <div className="text-xs font-medium text-blue-700 mb-1">
                                      Связанные материалы:
                                    </div>
                                    <div className="space-y-1">
                                      {allWorkLinks[subItem.id].map((link: any) => {
                                        const isEditing = editingLinkId === (link.id || link.link_id);
                                        
                                        // Create a material item object for dragging
                                        const linkedMaterialItem = {
                                          id: link.material_boq_item_id,
                                          description: link.material_description,
                                          unit: link.material_unit,
                                          consumption_coefficient: link.material_consumption_coefficient,
                                          conversion_coefficient: link.material_conversion_coefficient,
                                          unit_rate: link.material_unit_rate,
                                          item_type: 'material' as const,
                                          is_linked_material: true
                                        };
                                        
                                        return (
                                        <div key={link.id} className="mb-1">
                                          <div className="flex flex-col gap-1 pb-1 border-b border-blue-200 last:border-0">
                                            <div className="flex items-center justify-between text-xs">
                                              <div className="flex items-center flex-1 gap-1">
                                                <span className="font-medium text-gray-700">{link.material_description}</span>
                                                <span className="text-gray-400">
                                                  {link.material_consumption_coefficient && link.material_consumption_coefficient !== 1 && (
                                                    <span className="ml-2">К.расх: {link.material_consumption_coefficient}</span>
                                                  )}
                                                  {link.material_conversion_coefficient && link.material_conversion_coefficient !== 1 && (
                                                    <span className="ml-2">К.пер: {link.material_conversion_coefficient}</span>
                                                  )}
                                                  <span className="ml-2">Цена: {formatCurrency(link.material_unit_rate || 0)}/{link.material_unit}</span>
                                                </span>
                                              </div>
                                            <div className="flex items-center gap-2">
                                              <div className="text-blue-600 font-semibold">
                                                {formatCurrency(link.calculated_total || 0)}
                                              </div>
                                              {!isEditing ? (
                                                <>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      setEditingLinkId(link.id || link.link_id);
                                                      setEditingLinkData({
                                                        consumption_coefficient: link.material_consumption_coefficient,
                                                        conversion_coefficient: link.material_conversion_coefficient,
                                                        unit_rate: link.material_unit_rate
                                                      });
                                                    }}
                                                    className="text-blue-500 hover:text-blue-700 p-0.5"
                                                    title="Редактировать материал"
                                                  >
                                                    <EditOutlined style={{ fontSize: '12px' }} />
                                                  </button>
                                                  <Tooltip title="Переместить в другую работу">
                                                    <button
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        openMoveModal(
                                                          link.material_boq_item_id,
                                                          link.material_description,
                                                          subItem.id,
                                                          true,
                                                          link.id || link.link_id
                                                        );
                                                      }}
                                                      className="text-purple-500 hover:text-purple-700 p-0.5 transition-colors"
                                                      title="Переместить в другую работу"
                                                    >
                                                      <SendOutlined style={{ fontSize: '12px' }} />
                                                    </button>
                                                  </Tooltip>
                                                  <Tooltip title="Удалить материал">
                                                    <button
                                                      onClick={async (e) => {
                                                        e.stopPropagation();
                                                        // Полное удаление материала
                                                        await handleDeleteMaterial(
                                                          link.material_boq_item_id, 
                                                          link.id || link.link_id, 
                                                          link.material_description
                                                        );
                                                      }}
                                                      className="text-red-600 hover:text-red-800 p-0.5 transition-colors"
                                                      title="Удалить материал"
                                                    >
                                                      <DeleteOutlined style={{ fontSize: '12px' }} />
                                                    </button>
                                                  </Tooltip>
                                                </>
                                              ) : (
                                                <>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      handleUpdateLinkedMaterial(link.id || link.link_id, link.material_boq_item_id);
                                                    }}
                                                    className="text-green-500 hover:text-green-700 p-0.5"
                                                    title="Сохранить"
                                                  >
                                                    ✓
                                                  </button>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      setEditingLinkId(null);
                                                      setEditingLinkData({});
                                                    }}
                                                    className="text-gray-500 hover:text-gray-700 p-0.5"
                                                    title="Отмена"
                                                  >
                                                    ✕
                                                  </button>
                                                </>
                                              )}
                                            </div>
                                          </div>
                                          {!isEditing ? null : (
                                            <div className="grid grid-cols-3 gap-2 mt-2">
                                              <div>
                                                <label className="block text-xs text-gray-600 mb-0.5">К. расхода</label>
                                                <InputNumber
                                                  size="small"
                                                  value={editingLinkData.consumption_coefficient}
                                                  onChange={(value) => setEditingLinkData({...editingLinkData, consumption_coefficient: value})}
                                                  min={0}
                                                  step={0.0001}
                                                  className="w-full text-xs"
                                                />
                                              </div>
                                              <div>
                                                <label className="block text-xs text-gray-600 mb-0.5">К. перевода</label>
                                                <InputNumber
                                                  size="small"
                                                  value={editingLinkData.conversion_coefficient}
                                                  onChange={(value) => setEditingLinkData({...editingLinkData, conversion_coefficient: value})}
                                                  min={0}
                                                  step={0.0001}
                                                  className="w-full text-xs"
                                                />
                                              </div>
                                              <div>
                                                <label className="block text-xs text-gray-600 mb-0.5">Цена (₽)</label>
                                                <InputNumber
                                                  size="small"
                                                  value={editingLinkData.unit_rate}
                                                  onChange={(value) => setEditingLinkData({...editingLinkData, unit_rate: value})}
                                                  min={0}
                                                  step={0.01}
                                                  className="w-full text-xs"
                                                />
                                              </div>
                                            </div>
                                          )}
                                        </div>
                                        </div>
                                        );
                                      })}
                                    </div>
                                  </div>
                                        )}
                                      </div>
                                    ) : (
                                      // Несвязанные материалы
                                      <div className="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200 hover:bg-gray-100 transition-colors mb-1">
                                        {editingItem?.id === subItem.id ? (
                                          // Inline edit form для материалов
                                          <div className="flex-1 space-y-2 p-2 bg-white border-2 border-blue-300 rounded">
                                            {/* Название материала */}
                                            <div className="flex items-center gap-2">
                                              <label className="text-xs text-gray-600 w-24">Название:</label>
                                              <input
                                                type="text"
                                                value={editFormData.description}
                                                onChange={(e) => setEditFormData({...editFormData, description: e.target.value})}
                                                className="flex-1 px-2 py-1 text-sm border border-gray-300 rounded"
                                                placeholder="Название материала"
                                              />
                                            </div>
                                            
                                            {/* Цена и единица измерения */}
                                            <div className="flex items-center gap-2">
                                              <label className="text-xs text-gray-600 w-24">Цена:</label>
                                              <input
                                                type="number"
                                                value={editFormData.unit_rate}
                                                onChange={(e) => setEditFormData({...editFormData, unit_rate: parseFloat(e.target.value) || 0})}
                                                className="w-32 px-2 py-1 text-sm border border-gray-300 rounded"
                                                placeholder="Цена"
                                                step="0.01"
                                              />
                                              <span className="text-sm">₽/{subItem.unit}</span>
                                            </div>
                                            
                                            {/* Коэффициенты */}
                                            <div className="flex items-center gap-2">
                                              <label className="text-xs text-gray-600 w-24">К. расхода:</label>
                                              <input
                                                type="number"
                                                value={editFormData.consumption_coefficient}
                                                onChange={(e) => setEditFormData({...editFormData, consumption_coefficient: parseFloat(e.target.value) || 1})}
                                                className="w-32 px-2 py-1 text-sm border border-gray-300 rounded"
                                                placeholder="1.0000"
                                                step="0.0001"
                                              />
                                              <label className="text-xs text-gray-600 ml-2">К. перевода:</label>
                                              <input
                                                type="number"
                                                value={editFormData.conversion_coefficient}
                                                onChange={(e) => setEditFormData({...editFormData, conversion_coefficient: parseFloat(e.target.value) || 1})}
                                                className="w-32 px-2 py-1 text-sm border border-gray-300 rounded"
                                                placeholder="1.0000"
                                                step="0.0001"
                                              />
                                            </div>
                                            
                                            {/* Категория затрат */}
                                            <div className="flex items-center gap-2">
                                              <label className="text-xs text-gray-600 w-24">Затраты:</label>
                                              <div className="flex-1">
                                                <CostCascadeSelector
                                                  value={editFormData.cost_node_id}
                                                  onChange={(costNodeId, displayValue) => {
                                                    setEditFormData({
                                                      ...editFormData,
                                                      cost_node_id: costNodeId,
                                                      cost_node_display: displayValue
                                                    });
                                                  }}
                                                  placeholder="Выберите категорию затрат"
                                                  style={{ fontSize: '12px' }}
                                                />
                                              </div>
                                            </div>
                                            
                                            {/* Доставка */}
                                            <div className="flex items-center gap-2">
                                              <label className="text-xs text-gray-600 w-24">Доставка:</label>
                                              <select
                                                value={editFormData.delivery_price_type}
                                                onChange={(e) => setEditFormData({...editFormData, delivery_price_type: e.target.value as 'included' | 'not_included' | 'amount'})}
                                                className="px-2 py-1 text-sm border border-gray-300 rounded"
                                              >
                                                <option value="included">В цене</option>
                                                <option value="not_included">Не в цене</option>
                                                <option value="amount">Суммой</option>
                                              </select>
                                              {editFormData.delivery_price_type === 'amount' && (
                                                <>
                                                  <input
                                                    type="number"
                                                    value={editFormData.delivery_amount}
                                                    onChange={(e) => setEditFormData({...editFormData, delivery_amount: parseFloat(e.target.value) || 0})}
                                                    className="w-32 px-2 py-1 text-sm border border-gray-300 rounded"
                                                    placeholder="0.00"
                                                    step="0.01"
                                                  />
                                                  <span className="text-sm">₽</span>
                                                </>
                                              )}
                                            </div>
                                            
                                            {/* Кнопки сохранения/отмены */}
                                            <div className="flex justify-end gap-2 pt-2 border-t">
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  setEditingItem(null);
                                                }}
                                                className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50"
                                              >
                                                Отмена
                                              </button>
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  handleUpdateBOQItem();
                                                }}
                                                className="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600"
                                              >
                                                Сохранить
                                              </button>
                                            </div>
                                          </div>
                                        ) : (
                                          <>
                                            <div className="flex-1">
                                              <div className="flex items-center gap-2">
                                                <span className="text-sm font-medium">{subItem.description}</span>
                                                <span className="text-xs text-gray-500">
                                                  {subItem.quantity} {subItem.unit}
                                                </span>
                                                {subItem.consumption_coefficient && subItem.consumption_coefficient !== 1 && (
                                                  <span className="text-xs text-gray-500">К.расх: {subItem.consumption_coefficient}</span>
                                                )}
                                                {subItem.conversion_coefficient && subItem.conversion_coefficient !== 1 && (
                                                  <span className="text-xs text-gray-500">К.пер: {subItem.conversion_coefficient}</span>
                                                )}
                                              </div>
                                              <div className="text-xs text-gray-600 mt-1">
                                                Цена: {formatPriceWithCurrency(subItem.unit_rate || 0, subItem.currency_type)}/{subItem.unit}
                                                {subItem.currency_type && subItem.currency_type !== 'RUB' && subItem.currency_rate && (
                                                  <Tooltip title={`Курс: 1${CURRENCY_SYMBOLS[subItem.currency_type]} = ${subItem.currency_rate}₽`}>
                                                    <span className="ml-2 text-xs text-blue-600 cursor-help">
                                                      ({formatCurrency(subItem.unit_rate * subItem.currency_rate)})
                                                    </span>
                                                  </Tooltip>
                                                )}
                                                {(subItem as any).cost_node_display && (
                                                  <span className="ml-2 text-xs text-purple-600">
                                                    Затраты: {(subItem as any).cost_node_display}
                                                  </span>
                                                )}
                                              </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                              <span className="text-sm font-semibold text-blue-600">
                                                {formatCurrency(subItem.total_amount || 0)}
                                              </span>
                                              <Tooltip title="Привязать к работе">
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    openMoveModal(
                                                      subItem.id,
                                                      subItem.description || '',
                                                      null,
                                                      false
                                                    );
                                                  }}
                                                  className="text-purple-500 hover:text-purple-700 p-1 transition-colors"
                                                >
                                                  <LinkOutlined style={{ fontSize: '14px' }} />
                                                </button>
                                              </Tooltip>
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  updateSubItem(subItem);
                                                }}
                                                className="text-blue-500 hover:text-blue-700 p-1"
                                              >
                                                <EditOutlined style={{ fontSize: '14px' }} />
                                              </button>
                                              <button
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  removeSubItem(position.id, subItem.id);
                                                }}
                                                className="text-red-500 hover:text-red-700 p-1"
                                              >
                                                <CloseOutlined style={{ fontSize: '14px' }} />
                                              </button>
                                            </div>
                                          </>
                                        )}
                                      </div>
                                    )}
                              </div>
                              );
                            })}
                              </div>
                        </div>
                      )}

                      {/* Форма добавления */}
                      <div className="bg-white p-3 rounded-lg border">
                        <h4 className="font-medium mb-2 text-sm text-gray-700">Добавить позицию:</h4>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-0.5">
                              Тип
                            </label>
                            <select
                              value={formData.type}
                              onChange={(e) => handleInputChange('type', e.target.value)}
                              className="w-full p-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                            >
                              <option value="work">🔧 Работы</option>
                              <option value="material">📦 Материалы</option>
                            </select>
                          </div>

                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-0.5">
                              Наименование
                            </label>
                            <AutoCompleteSearch
                              type={formData.type}
                              value={formData.name}
                              onChange={handleNameChange}
                              onSelect={handleItemSelect}
                              placeholder={`Поиск ${formData.type === 'work' ? 'работ' : 'материалов'} в справочнике...`}
                              className="w-full text-xs"
                            />
                          </div>
                        </div>

                        <div className={`grid grid-cols-1 ${formData.type === 'work' ? 'md:grid-cols-3' : 'md:grid-cols-2'} gap-2`}>
                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-0.5">
                              Ед. изм.
                            </label>
                            <select
                              value={formData.unit}
                              onChange={(e) => handleInputChange('unit', e.target.value)}
                              className="w-full p-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                            >
                              {units.map(unit => (
                                <option key={unit} value={unit}>{unit}</option>
                              ))}
                            </select>
                          </div>

                          {/* Показываем поле объема только для работ */}
                          {formData.type === 'work' && (
                            <div>
                              <label className="block text-xs font-medium text-gray-600 mb-0.5">
                                Объем
                              </label>
                              <input
                                type="number"
                                step="0.01"
                                value={formData.quantity}
                                onChange={(e) => handleInputChange('quantity', e.target.value)}
                                placeholder="0"
                                className="w-full p-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                              />
                            </div>
                          )}

                          <div>
                            <label className="block text-xs font-medium text-gray-600 mb-0.5">
                              Цена (₽)
                            </label>
                            <input
                              type="number"
                              step="0.01"
                              value={formData.price}
                              onChange={(e) => handleInputChange('price', e.target.value)}
                              placeholder="0"
                              className="w-full p-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                            />
                          </div>
                        </div>

                        {/* Поля коэффициентов для материалов */}
                        {formData.type === 'material' && (
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                            <div>
                              <label className="block text-xs font-medium text-gray-600 mb-0.5" title="Коэффициент расхода материала на единицу работ">
                                Коэф. расхода материала
                              </label>
                              <input
                                type="number"
                                step="0.0001"
                                value={formData.consumptionCoefficient}
                                onChange={(e) => handleInputChange('consumptionCoefficient', e.target.value)}
                                placeholder="1.0000"
                                className="w-full p-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                              />
                            </div>

                            <div>
                              <label className="block text-xs font-medium text-gray-600 mb-0.5" title="Коэффициент для перевода единиц измерения">
                                Коэф. перевода ед. изм.
                              </label>
                              <input
                                type="number"
                                step="0.0001"
                                value={formData.conversionCoefficient}
                                onChange={(e) => handleInputChange('conversionCoefficient', e.target.value)}
                                placeholder="1.0000"
                                className="w-full p-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                              />
                            </div>
                          </div>
                        )}

                        {/* Поле выбора категории затрат */}
                        <div className="mt-2">
                          <label className="block text-xs font-medium text-gray-600 mb-0.5">
                            Категория затрат
                          </label>
                          <CostCascadeSelector
                            value={formData.cost_node_id}
                            onChange={(costNodeId, displayValue) => {
                              setFormData(prev => ({
                                ...prev,
                                cost_node_id: costNodeId,
                                cost_node_display: displayValue
                              }));
                            }}
                            placeholder="Выберите категорию затрат"
                            style={{ fontSize: '12px' }}
                          />
                        </div>

                        {/* Поля доставки для материалов */}
                        {formData.type === 'material' && (
                          <div className="mt-2">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                              <div>
                                <label className="block text-xs font-medium text-gray-600 mb-0.5">
                                  Цена доставки
                                </label>
                                <select
                                  value={formData.deliveryPriceType}
                                  onChange={(e) => handleInputChange('deliveryPriceType', e.target.value)}
                                  className="w-full p-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                >
                                  <option value="included">В цене</option>
                                  <option value="not_included">Не в цене</option>
                                  <option value="amount">Суммой</option>
                                </select>
                              </div>

                              {formData.deliveryPriceType === 'amount' && (
                                <div>
                                  <label className="block text-xs font-medium text-gray-600 mb-0.5">
                                    Сумма доставки (₽)
                                  </label>
                                  <input
                                    type="number"
                                    step="0.01"
                                    value={formData.deliveryAmount}
                                    onChange={(e) => handleInputChange('deliveryAmount', e.target.value)}
                                    placeholder="0.00"
                                    className="w-full p-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                  />
                                </div>
                              )}
                            </div>
                          </div>
                        )}

                        {((formData.type === 'work' && formData.quantity && formData.price) || 
                          (formData.type === 'material' && formData.price)) && (
                          <div className="mt-2 p-2 bg-blue-50 rounded">
                            <div className="flex justify-between items-center text-xs">
                              <span className="font-medium text-blue-900">
                                {formData.type === 'material' ? 'Цена за единицу:' : 'Стоимость:'}
                              </span>
                              <span className="font-bold text-blue-600">
                                {formData.type === 'material' 
                                  ? formatCurrency(parseFloat(formData.price || '0'))
                                  : formatCurrency(parseFloat(formData.quantity || '0') * parseFloat(formData.price || '0'))}
                              </span>
                            </div>
                          </div>
                        )}

                        <div className="flex gap-2 mt-2">
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              addItem();
                            }}
                            disabled={!formData.name || !formData.price || (formData.type === 'work' && !formData.quantity)}
                            className="flex-1 bg-blue-600 text-white py-1.5 px-3 rounded text-xs hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-medium"
                          >
                            <PlusOutlined style={{ fontSize: '12px', marginRight: '2px' }} />
                            Добавить
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              closeModal();
                            }}
                            className="px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-xs hover:bg-gray-50 transition-colors"
                          >
                            Свернуть
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>

        {positions.length === 0 && !positionsLoading && (
          <div className="text-center py-8">
            <div className="text-gray-400 text-base mb-2">
              Позиции заказчика не найдены
            </div>
            <p className="text-gray-500 text-sm">
              Создайте позиции заказчика для начала работы с ВОР
            </p>
          </div>
        )}
      </div>

      {/* Conflict Resolution Modal */}
      <Modal
        title="Конфликт перемещения материала"
        open={conflictModal.visible}
        onOk={handleConflictResolution}
        onCancel={() => setConflictModal({
          visible: false,
          srcId: null,
          tgtId: null,
          targetWorkId: null,
          materialName: '',
          sourceworkName: '',
          targetWorkName: ''
        })}
        okText="Применить"
        cancelText="Отмена"
        width={500}
      >
        <div className="space-y-4">
          <p>
            Материал <strong>{conflictModal.materialName}</strong> уже привязан к работе <strong>{conflictModal.targetWorkName}</strong>.
          </p>
          <p>Выберите стратегию разрешения конфликта:</p>
          
          <Radio.Group 
            value={conflictStrategy} 
            onChange={(e) => setConflictStrategy(e.target.value)}
            className="space-y-2"
          >
            <Radio value="sum" className="block">
              <div>
                <div className="font-medium">Суммировать объемы</div>
                <div className="text-sm text-gray-500">
                  Объемы материала будут сложены, сохранив общее количество
                </div>
              </div>
            </Radio>
            <Radio value="replace" className="block">
              <div>
                <div className="font-medium">Заменить</div>
                <div className="text-sm text-gray-500">
                  Использовать коэффициенты из работы {conflictModal.sourceworkName}
                </div>
              </div>
            </Radio>
          </Radio.Group>
        </div>
      </Modal>

      {/* Модальное окно для перемещения материала */}
      <Modal
        title={
          <div className="flex items-center gap-2">
            <SendOutlined className="text-purple-600" />
            <span>Переместить материал</span>
          </div>
        }
        open={moveModal.visible}
        onCancel={() => setMoveModal({
          visible: false,
          materialId: null,
          materialName: '',
          currentWorkId: null,
          currentWorkName: '',
          isLinkedMaterial: false
        })}
        footer={null}
        width={600}
      >
        <div className="space-y-4">
          <div className="bg-blue-50 p-3 rounded">
            <p className="text-sm">
              <strong>Материал:</strong> {moveModal.materialName}
            </p>
            {moveModal.currentWorkId && (
              <p className="text-sm mt-1">
                <strong>Текущая работа:</strong> {moveModal.currentWorkName}
              </p>
            )}
          </div>

          <div>
            <p className="text-sm font-medium mb-3">
              Выберите работу для привязки материала:
            </p>
            
            {selectedPosition && selectedPosition.boq_items ? (
              <List
                dataSource={selectedPosition.boq_items.filter(item => 
                  item.item_type === 'work' && item.id !== moveModal.currentWorkId
                )}
                renderItem={(work) => (
                  <List.Item
                    className="cursor-pointer hover:bg-gray-50 px-3 py-2 rounded transition-colors"
                    onClick={() => handleMoveMaterial(work.id)}
                  >
                    <div className="flex items-center justify-between w-full">
                      <div className="flex-1">
                        <div className="font-medium">{work.description}</div>
                        <div className="text-sm text-gray-500">
                          {work.quantity} {work.unit}
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-semibold text-green-600">
                          {formatCurrency(work.total_amount || 0)}
                        </span>
                        <SendOutlined className="text-gray-400" />
                      </div>
                    </div>
                  </List.Item>
                )}
                locale={{
                  emptyText: (
                    <Empty
                      description="Нет доступных работ"
                      image={Empty.PRESENTED_IMAGE_SIMPLE}
                    />
                  )
                }}
              />
            ) : (
              <Empty description="Нет доступных работ" />
            )}
          </div>
        </div>
      </Modal>

    </div>
  );
};

export default TenderBOQManagerNew;