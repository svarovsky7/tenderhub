import * as XLSX from 'xlsx';

/**
 * Generate Excel template for construction costs import
 */
export const generateConstructionCostsTemplate = () => {
  console.log('üöÄ [generateConstructionCostsTemplate] Creating template');

  // Sample data for template
  const sampleData = [
    {
      '–ö–æ–¥': 'MAT-001',
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': '–ë–µ—Ç–æ–Ω –ú300',
      '–ï–¥–∏–Ω–∏—Ü–∞': '–º¬≥',
      '–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞': 4500,
      '–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞': 4800,
      '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',
      '–ü–æ—Å—Ç–∞–≤—â–∏–∫': '–û–û–û "–°—Ç—Ä–æ–π–ü–æ—Å—Ç–∞–≤–∫–∞"',
      '–û–ø–∏—Å–∞–Ω–∏–µ': '–ë–µ—Ç–æ–Ω –º–∞—Ä–∫–∏ –ú300 –¥–ª—è —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞',
      '–¢–µ–≥–∏': '–±–µ—Ç–æ–Ω, —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç, –º300'
    },
    {
      '–ö–æ–¥': 'MAT-002',
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': '–ê—Ä–º–∞—Ç—É—Ä–∞ –ê500–° d12',
      '–ï–¥–∏–Ω–∏—Ü–∞': '—Ç–Ω',
      '–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞': 85000,
      '–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞': 87000,
      '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',
      '–ü–æ—Å—Ç–∞–≤—â–∏–∫': '–û–û–û "–ú–µ—Ç–∞–ª–ª–¢—Ä–µ–π–¥"',
      '–û–ø–∏—Å–∞–Ω–∏–µ': '–ê—Ä–º–∞—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–∞ –ê500–° –¥–∏–∞–º–µ—Ç—Ä 12–º–º',
      '–¢–µ–≥–∏': '–∞—Ä–º–∞—Ç—É—Ä–∞, –º–µ—Ç–∞–ª–ª, –∞500—Å'
    },
    {
      '–ö–æ–¥': 'WORK-001',
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': '–ú–æ–Ω—Ç–∞–∂ –æ–ø–∞–ª—É–±–∫–∏',
      '–ï–¥–∏–Ω–∏—Ü–∞': '–º¬≤',
      '–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞': 800,
      '–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞': null,
      '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': '–†–∞–±–æ—Ç—ã',
      '–ü–æ—Å—Ç–∞–≤—â–∏–∫': null,
      '–û–ø–∏—Å–∞–Ω–∏–µ': '–ú–æ–Ω—Ç–∞–∂ —â–∏—Ç–æ–≤–æ–π –æ–ø–∞–ª—É–±–∫–∏ –¥–ª—è —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞',
      '–¢–µ–≥–∏': '–æ–ø–∞–ª—É–±–∫–∞, –º–æ–Ω—Ç–∞–∂, —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç'
    },
    {
      '–ö–æ–¥': 'WORK-002',
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': '–£–∫–ª–∞–¥–∫–∞ –±–µ—Ç–æ–Ω–∞',
      '–ï–¥–∏–Ω–∏—Ü–∞': '–º¬≥',
      '–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞': 1200,
      '–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞': null,
      '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': '–†–∞–±–æ—Ç—ã',
      '–ü–æ—Å—Ç–∞–≤—â–∏–∫': null,
      '–û–ø–∏—Å–∞–Ω–∏–µ': '–£–∫–ª–∞–¥–∫–∞ –±–µ—Ç–æ–Ω–∞ —Å –≤–∏–±—Ä–æ—É–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ–º',
      '–¢–µ–≥–∏': '–±–µ—Ç–æ–Ω, —É–∫–ª–∞–¥–∫–∞, –≤–∏–±—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ'
    },
    {
      '–ö–æ–¥': 'TECH-001',
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': '–ê—Ä–µ–Ω–¥–∞ –∫—Ä–∞–Ω–∞ 25—Ç',
      '–ï–¥–∏–Ω–∏—Ü–∞': '—Å–º–µ–Ω–∞',
      '–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞': 45000,
      '–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞': 48000,
      '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': '–¢–µ—Ö–Ω–∏–∫–∞ –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ',
      '–ü–æ—Å—Ç–∞–≤—â–∏–∫': '–û–û–û "–°–ø–µ—Ü–¢–µ—Ö–Ω–∏–∫–∞"',
      '–û–ø–∏—Å–∞–Ω–∏–µ': '–ê—Ä–µ–Ω–¥–∞ –∞–≤—Ç–æ–∫—Ä–∞–Ω–∞ –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å—é 25 —Ç–æ–Ω–Ω',
      '–¢–µ–≥–∏': '–∫—Ä–∞–Ω, –∞—Ä–µ–Ω–¥–∞, —Ç–µ—Ö–Ω–∏–∫–∞'
    }
  ];

  // Create workbook and worksheet
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(sampleData);

  // Set column widths
  const colWidths = [
    { wch: 12 }, // –ö–æ–¥
    { wch: 30 }, // –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
    { wch: 10 }, // –ï–¥–∏–Ω–∏—Ü–∞
    { wch: 15 }, // –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
    { wch: 15 }, // –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞
    { wch: 20 }, // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
    { wch: 25 }, // –ü–æ—Å—Ç–∞–≤—â–∏–∫
    { wch: 40 }, // –û–ø–∏—Å–∞–Ω–∏–µ
    { wch: 30 }  // –¢–µ–≥–∏
  ];
  ws['!cols'] = colWidths;

  // Add worksheet to workbook
  XLSX.utils.book_append_sheet(wb, ws, '–ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ');

  // Create instructions sheet
  const instructions = [
    ['–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ó–ê–ü–û–õ–ù–ï–ù–ò–Æ'],
    [''],
    ['–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:'],
    ['‚Ä¢ –ö–æ–¥ - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –∑–∞—Ç—Ä–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: MAT-001, WORK-002)'],
    ['‚Ä¢ –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ - –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç'],
    ['‚Ä¢ –ï–¥–∏–Ω–∏—Ü–∞ - –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è (—à—Ç, –º¬≤, –º¬≥, –∫–≥, —Ç–Ω, —á–∞—Å, —Å–º–µ–Ω–∞)'],
    ['‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ - –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (—á–∏—Å–ª–æ)'],
    [''],
    ['–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è:'],
    ['‚Ä¢ –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ - —Ç–µ–∫—É—â–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (—á–∏—Å–ª–æ)'],
    ['‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è - –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞'],
    ['‚Ä¢ –ü–æ—Å—Ç–∞–≤—â–∏–∫ - –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞'],
    ['‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç'],
    ['‚Ä¢ –¢–µ–≥–∏ - –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –¥–ª—è –ø–æ–∏—Å–∫–∞'],
    [''],
    ['–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:'],
    ['1. –ù–µ –∏–∑–º–µ–Ω—è–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫'],
    ['2. –¶–µ–Ω—ã —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —á–∏—Å–ª–∞–º–∏ –±–µ–∑ —Å–∏–º–≤–æ–ª–∞ –≤–∞–ª—é—Ç—ã'],
    ['3. –î–ª—è –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –æ—Å—Ç–∞–≤—å—Ç–µ —è—á–µ–π–∫—É –ø—É—Å—Ç–æ–π'],
    ['4. –¢–µ–≥–∏ —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ –∑–∞–ø—è—Ç—ã–º–∏'],
    ['5. –£–¥–∞–ª–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∂–µ']
  ];

  const wsInstructions = XLSX.utils.aoa_to_sheet(instructions);
  wsInstructions['!cols'] = [{ wch: 80 }];
  XLSX.utils.book_append_sheet(wb, wsInstructions, '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è');

  // Write file
  XLSX.writeFile(wb, '–®–∞–±–ª–æ–Ω_–∑–∞—Ç—Ä–∞—Ç—ã_–Ω–∞_—Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ.xlsx');
  
  console.log('‚úÖ [generateConstructionCostsTemplate] Template created');
};

/**
 * Export construction costs to Excel
 */
export const exportConstructionCostsToExcel = (costs: any[], fileName = 'construction_costs.xlsx') => {
  console.log('üöÄ [exportConstructionCostsToExcel] Exporting costs:', costs.length);

  const exportData = costs.map(cost => ({
    '–ö–æ–¥': cost.code,
    '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ': cost.name,
    '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': cost.category?.name || '',
    '–ï–¥–∏–Ω–∏—Ü–∞': cost.unit,
    '–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞': cost.base_price,
    '–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞': cost.market_price || '',
    '–ü–æ—Å—Ç–∞–≤—â–∏–∫': cost.supplier || '',
    '–û–ø–∏—Å–∞–Ω–∏–µ': cost.description || '',
    '–¢–µ–≥–∏': cost.tags?.join(', ') || '',
    '–°—Ç–∞—Ç—É—Å': cost.is_active ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ',
    '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è': new Date(cost.created_at).toLocaleDateString('ru-RU'),
    '–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è': new Date(cost.updated_at).toLocaleDateString('ru-RU')
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(exportData);

  // Set column widths
  const colWidths = [
    { wch: 12 }, // –ö–æ–¥
    { wch: 30 }, // –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
    { wch: 20 }, // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
    { wch: 10 }, // –ï–¥–∏–Ω–∏—Ü–∞
    { wch: 15 }, // –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
    { wch: 15 }, // –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞
    { wch: 25 }, // –ü–æ—Å—Ç–∞–≤—â–∏–∫
    { wch: 40 }, // –û–ø–∏—Å–∞–Ω–∏–µ
    { wch: 30 }, // –¢–µ–≥–∏
    { wch: 12 }, // –°—Ç–∞—Ç—É—Å
    { wch: 15 }, // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
    { wch: 15 }  // –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  ];
  ws['!cols'] = colWidths;

  XLSX.utils.book_append_sheet(wb, ws, '–ó–∞—Ç—Ä–∞—Ç—ã');
  XLSX.writeFile(wb, fileName);

  console.log('‚úÖ [exportConstructionCostsToExcel] Export completed');
};