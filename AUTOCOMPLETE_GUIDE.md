# Руководство по автокомплиту в ВОР

## 🎯 Новый функционал

Добавлен поиск по справочнику с автозаполнением единиц измерения в форме добавления работ и материалов.

## ✨ Возможности

### 1. **Поиск по справочнику**
- Поиск работ и материалов в реальном времени
- Поиск по названию и описанию
- Показ первых 10 элементов при пустом поле
- Показ до 20 результатов при поиске

### 2. **Автозаполнение единиц измерения**
- При выборе элемента из справочника автоматически заполняется поле "Ед. изм."
- Сохраняется связь с элементом справочника (material_id или work_id)

### 3. **Умная форма**
- При смене типа (Работы ↔ Материалы) очищается поле поиска
- Меняется плейсхолдер в зависимости от типа
- Можно вводить произвольный текст или выбирать из справочника

## 🛠 Компоненты

### `AutoCompleteSearch.tsx`
**Местоположение**: `/src/components/common/AutoCompleteSearch.tsx`

**Пропсы**:
```typescript
interface AutoCompleteSearchProps {
  type: 'work' | 'material';           // Тип справочника
  value: string;                       // Текущее значение
  onChange: (value: string) => void;   // Изменение значения
  onSelect: (value: string, option: {  // Выбор элемента
    id: string; 
    name: string; 
    unit: string 
  }) => void;
  placeholder: string;                 // Подсказка
  className?: string;                  // CSS классы
  disabled?: boolean;                  // Заблокировать
}
```

**Особенности**:
- Загружает все элементы справочника при монтировании
- Фильтрует локально для быстрого отклика
- Показывает спиннер во время загрузки
- Красивый дизайн с единицами измерения справа

### `TenderBOQManagerNew.tsx`
**Изменения**:
- Добавлено поле `selectedItemId` в состояние формы
- Заменен input на `AutoCompleteSearch`
- Добавлена логика автозаполнения единиц измерения
- Сохраняется связь с элементами справочника

## 🔄 Логика работы

### 1. **При загрузке компонента**
```typescript
// AutoCompleteSearch загружает все материалы/работы
const result = type === 'material' 
  ? await materialsApi.getAll({ search: '' }, { limit: 1000 })
  : await worksApi.getAll({ search: '' }, { limit: 1000 });
```

### 2. **При вводе текста**
```typescript
// Фильтрация по названию и описанию
const filtered = allItems.filter(item => 
  item.name.toLowerCase().includes(searchLower) ||
  (item.description && item.description.toLowerCase().includes(searchLower))
);
```

### 3. **При выборе элемента**
```typescript
// Автозаполнение полей
setFormData(prev => ({
  ...prev,
  name: option.name,
  unit: option.unit,           // 🎯 Автозаполнение!
  selectedItemId: option.id
}));
```

### 4. **При сохранении в БД**
```typescript
const newItemData: BOQItemInsert = {
  // ... другие поля
  material_id: formData.type === 'material' ? formData.selectedItemId : null,
  work_id: formData.type === 'work' ? formData.selectedItemId : null
};
```

## 🎨 Дизайн

### Внешний вид элементов списка:
```
┌─────────────────────────────────────────────┐
│ Цемент портландский М400                 кг │
│ Цемент для строительных работ              │
└─────────────────────────────────────────────┘
```

### Состояния:
- 🔍 **Поиск**: Показывается спиннер и SearchOutlined
- 📋 **Результаты**: Список с названиями, описаниями и единицами
- ❌ **Не найдено**: "Не найдено"

## 📚 Использование

### 1. **Открыть ВОР**
- Перейти на страницу `/tender/:id/boq`
- Нажать на любую позицию заказчика

### 2. **Добавить работу/материал**
- Выбрать тип (🔧 Работы или 📦 Материалы)
- Начать ввод в поле "Наименование"
- Выбрать элемент из выпадающего списка
- Единица измерения заполнится автоматически!

### 3. **Результат**
- В базе сохраняется связь с элементом справочника
- При редактировании будет доступна полная информация об элементе

## 🔧 Техническая информация

### База данных:
- `boq_items.material_id` - ссылка на элемент из `materials_library`
- `boq_items.work_id` - ссылка на элемент из `works_library`
- Поле заполняется только при выборе из справочника

### API:
- Используется существующие `materialsApi.getAll()` и `worksApi.getAll()`
- Загрузка происходит один раз при монтировании компонента
- Фильтрация выполняется на клиенте для скорости

### Производительность:
- Локальная фильтрация для мгновенного отклика
- Ограничение результатов (10 по умолчанию, 20 при поиске)
- Отложенная загрузка опций

## 🚀 Будущие улучшения

- [ ] Кэширование результатов поиска
- [ ] Группировка по категориям
- [ ] Показ цен из справочника
- [ ] Возможность добавления новых элементов прямо из интерфейса
- [ ] Избранные элементы

## 🐛 Известные ограничения

1. Загружается максимум 1000 элементов из каждого справочника
2. Фильтрация работает только по названию и описанию
3. Нет группировки по категориям
4. При вводе произвольного текста связь со справочником не создается