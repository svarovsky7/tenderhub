# Исправления для решения ошибки 409 Conflict

## Проблема
Ошибка 409 (Conflict) при импорте Excel файлов из-за попыток создания дублирующихся единиц измерения.

## Выполненные исправления

### 1. Улучшена обработка единиц измерения
- Добавлена проверка по `title` И `code` при поиске существующих единиц
- Добавлена проверка на дублирование кода перед созданием новой единицы
- При ошибке создания - попытка найти существующую единицу с тем же кодом
- Улучшено логирование для отладки

### 2. Исправлено создание cost_nodes
- Убрана проблемная функция `.single()` которая возвращала ошибки
- Добавлено явное указание `is_active: true` при создании записей
- Улучшена обработка ошибок с детальным логированием

### 3. Добавлена кнопка "Тест создания"
- Позволяет проверить создание категорий через UI
- Помогает диагностировать проблемы с правами доступа

## Следующие шаги

1. **Выполните в Supabase SQL Editor**:
```sql
-- Проверьте ограничения
SELECT 
    tc.table_name,
    tc.constraint_name,
    tc.constraint_type,
    kcu.column_name
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu 
    ON tc.constraint_name = kcu.constraint_name
WHERE tc.table_schema = 'public'
  AND tc.table_name IN ('cost_nodes', 'units', 'location')
  AND tc.constraint_type IN ('UNIQUE', 'PRIMARY KEY')
ORDER BY tc.table_name, tc.constraint_name;
```

2. **Проверьте дубликаты в units**:
```sql
SELECT code, COUNT(*) as count 
FROM units 
GROUP BY code 
HAVING COUNT(*) > 1;
```

3. **Попробуйте импорт снова** - теперь должно работать с детальным логированием в консоли

## Ключевые изменения в коде
- Проверка существования единиц измерения перед созданием
- Обработка конфликтов при создании единиц измерения
- Детальное логирование всех операций
- Улучшенная обработка ошибок без прерывания всего процесса